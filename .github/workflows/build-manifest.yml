name: Build fastener manifest

on:
  push:
    branches: [ main ]   # change to master if needed
  workflow_dispatch:     # allows manual runs

permissions:
  contents: write        # let the workflow commit manifest files

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate manifest from STL filenames
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const repoRoot = process.cwd();
          const boltsDir = path.join(repoRoot, 'Bolts');

          function walk(dir) {
            let out = [];
            if (!fs.existsSync(dir)) return out;
            for (const e of fs.readdirSync(dir, { withFileTypes: true })) {
              const full = path.join(dir, e.name);
              if (e.isDirectory()) out = out.concat(walk(full));
              else if (e.isFile() && /\.stl$/i.test(e.name)) out.push(full);
            }
            return out;
          }

          function parse(relPath) {
            const filename = path.basename(relPath);
            const base = filename.replace(/\.stl$/i, '');
            const parts = relPath.split('/'); // Bolts/<Family>/<Standard>/STL/<file>
            const category = parts[0] || '';
            const family   = parts[1] || '';
            const standard = parts[2] || '';

            const m = base.match(
              /^(?<type>[A-Za-z]+Head)_(?<M>M\d+(?:\.\d+)?)x(?<L>\d+(?:\.\d+)?)_(?<std>ISO\d+|DIN\d+|ASME[\w-]+)?$/i
            );

            const type = m?.groups?.type || family;
            const diameter = m?.groups?.M || null;   // "M10"
            const length = m?.groups?.L || null;     // "20"
            const stdInName = m?.groups?.std || null;

            return {
              path: relPath.replace(/\\/g,'/'),
              filename,
              category,
              family,
              standard,              // from folder
              type,                  // from filename (SocketHead/FlatHead)
              diameter,              // e.g., "M10"
              length,                // e.g., "20"
              standardFromName: stdInName
            };
          }

          const filesAbs = walk(boltsDir);
          const filesRel = filesAbs.map(p => path.relative(repoRoot, p).replace(/\\/g, '/'));
          const items = filesRel.map(parse);

          const manifest = {
            generatedAt: new Date().toISOString(),
            repo: process.env.GITHUB_REPOSITORY,
            items
          };

          fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
          fs.writeFileSync('manifest.js', 'window.FASTENER_MANIFEST=' + JSON.stringify(manifest) + ';\n');
          console.log(`Wrote manifest for ${items.length} STL files`);
          NODE

      - name: Commit manifest
        uses: EndBug/add-and-commit@v9
        with:
          add: "manifest.json manifest.js"
          message: "Build: update fastener manifest"
