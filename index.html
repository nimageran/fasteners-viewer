<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fasteners STL Viewer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #0a0e1a;
      color: #e4e6eb;
    }
    
    #ui {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #141824;
      padding: 20px;
      border-bottom: 2px solid #2a3142;
      z-index: 1000;
      max-height: 50vh;
      overflow-y: auto;
    }
    
    h1 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #a5b4fc;
    }
    
    .row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .field {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    label {
      font-size: 11px;
      color: #9ca3af;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    select, input, button {
      padding: 8px 12px;
      background: #1a1f2e;
      border: 1px solid #2d3548;
      border-radius: 4px;
      color: #e4e6eb;
      font-size: 14px;
      min-width: 150px;
    }
    
    select {
      cursor: pointer;
    }
    
    select:focus, input:focus {
      outline: 2px solid #3b82f6;
      border-color: #3b82f6;
    }
    
    button {
      background: #2563eb;
      border-color: #3b82f6;
      cursor: pointer;
      font-weight: 600;
      padding: 8px 24px;
    }
    
    button:hover {
      background: #1d4ed8;
    }
    
    button:disabled {
      background: #374151;
      cursor: not-allowed;
      opacity: 0.5;
    }
    
    #fileList {
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      background: #1a1f2e;
      border: 1px solid #2d3548;
      border-radius: 4px;
      padding: 10px;
    }
    
    .file-item {
      padding: 8px;
      margin: 4px 0;
      background: #0f1219;
      border: 1px solid #2d3548;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .file-item:hover {
      background: #1a1f2e;
      border-color: #3b82f6;
    }
    
    .file-item.selected {
      background: #1e3a8a;
      border-color: #3b82f6;
    }
    
    #viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1;
    }
    
    #info {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(20, 24, 36, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid #2a3142;
      border-radius: 6px;
      padding: 15px;
      min-width: 250px;
      font-size: 13px;
      z-index: 100;
    }
    
    #info div {
      margin: 5px 0;
    }
    
    .status {
      margin-top: 10px;
      padding: 8px;
      background: #1a1f2e;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
    }
    
    .checks {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .checks label {
      display: flex;
      align-items: center;
      gap: 5px;
      text-transform: none;
      cursor: pointer;
    }
    
    input[type="checkbox"] {
      min-width: auto;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="viewer"></div>
  
  <div id="ui">
    <h1>ðŸ”© Fasteners STL Viewer</h1>
    
    <div class="row">
      <div class="field">
        <label>GitHub Path</label>
        <input type="text" id="pathInput" value="Bolts/Socket_Head/ISO4762/STL" placeholder="e.g., Bolts/Socket_Head/ISO4762/STL">
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button id="scanBtn">Scan Folder</button>
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button id="toggleUI">Hide UI â–²</button>
      </div>
    </div>
    
    <div class="row checks">
      <label><input type="checkbox" id="gridCheck" checked> Grid</label>
      <label><input type="checkbox" id="axesCheck" checked> Axes</label>
      <label><input type="checkbox" id="rotateCheck"> Auto Rotate</label>
    </div>
    
    <div class="status" id="status">Enter a path and click "Scan Folder"</div>
    
    <div id="fileList"></div>
  </div>

  <div id="info">
    <div><strong>File:</strong> <span id="fileName">-</span></div>
    <div><strong>Size:</strong> <span id="fileSize">-</span></div>
    <div><strong>Triangles:</strong> <span id="fileTris">-</span></div>
  </div>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/controls/OrbitControls.js';
    import { STLLoader } from 'https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/loaders/STLLoader.js';

    // Config
    const GITHUB_USER = "nimageran";
    const GITHUB_REPO = "fasteners-viewer";
    const GITHUB_BRANCH = "main";

    // DOM
    const pathInput = document.getElementById('pathInput');
    const scanBtn = document.getElementById('scanBtn');
    const toggleUI = document.getElementById('toggleUI');
    const fileList = document.getElementById('fileList');
    const status = document.getElementById('status');
    const gridCheck = document.getElementById('gridCheck');
    const axesCheck = document.getElementById('axesCheck');
    const rotateCheck = document.getElementById('rotateCheck');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const fileTris = document.getElementById('fileTris');
    const uiPanel = document.getElementById('ui');

    // Three.js setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 10000);
    camera.position.set(100, 80, 120);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setClearColor(0x0a0e1a);
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.getElementById('viewer').appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    // Lighting
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
    light1.position.set(5, 10, 7);
    scene.add(light1);
    const light2 = new THREE.DirectionalLight(0xffffff, 0.4);
    light2.position.set(-5, 5, -5);
    scene.add(light2);

    // Helpers
    const grid = new THREE.GridHelper(200, 20, 0x444444, 0x222222);
    scene.add(grid);
    const axes = new THREE.AxesHelper(100);
    scene.add(axes);

    gridCheck.addEventListener('change', () => grid.visible = gridCheck.checked);
    axesCheck.addEventListener('change', () => axes.visible = axesCheck.checked);
    rotateCheck.addEventListener('change', () => controls.autoRotate = rotateCheck.checked);

    let currentMesh = null;
    const loader = new STLLoader();

    // Toggle UI
    let uiVisible = true;
    toggleUI.addEventListener('click', () => {
      uiVisible = !uiVisible;
      if (uiVisible) {
        uiPanel.style.display = 'block';
        toggleUI.textContent = 'Hide UI â–²';
      } else {
        uiPanel.style.display = 'none';
        toggleUI.textContent = 'Show UI â–¼';
        toggleUI.style.display = 'block';
        toggleUI.style.position = 'fixed';
        toggleUI.style.top = '10px';
        toggleUI.style.left = '10px';
        toggleUI.style.zIndex = '1000';
      }
    });

    // Scan folder using GitHub API
    async function scanFolder() {
      const path = pathInput.value.trim();
      if (!path) {
        status.textContent = 'Please enter a path';
        return;
      }

      status.textContent = 'Scanning...';
      scanBtn.disabled = true;
      fileList.innerHTML = '';

      try {
        const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}?ref=${GITHUB_BRANCH}`;
        console.log('Fetching:', apiUrl);
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const files = await response.json();
        const stlFiles = files.filter(f => f.name.toLowerCase().endsWith('.stl'));

        if (stlFiles.length === 0) {
          status.textContent = 'No STL files found in this path';
          return;
        }

        status.textContent = `Found ${stlFiles.length} STL files`;
        
        stlFiles.forEach(file => {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.textContent = file.name;
          div.onclick = () => loadSTL(file.download_url, file.name, div);
          fileList.appendChild(div);
        });

      } catch (error) {
        console.error('Scan error:', error);
        status.textContent = `Error: ${error.message}`;
      } finally {
        scanBtn.disabled = false;
      }
    }

    scanBtn.addEventListener('click', scanFolder);

    // Load STL
    async function loadSTL(url, name, itemDiv) {
      // Update selection
      document.querySelectorAll('.file-item').forEach(el => el.classList.remove('selected'));
      if (itemDiv) itemDiv.classList.add('selected');

      status.textContent = 'Loading...';
      console.log('Loading STL:', url);

      if (currentMesh) {
        scene.remove(currentMesh);
        currentMesh.geometry.dispose();
        currentMesh.material.dispose();
      }

      try {
        const geometry = await new Promise((resolve, reject) => {
          loader.load(url, resolve, undefined, reject);
        });

        const material = new THREE.MeshStandardMaterial({
          color: 0xc7d2fe,
          metalness: 0.3,
          roughness: 0.5
        });

        currentMesh = new THREE.Mesh(geometry, material);
        scene.add(currentMesh);

        // Center and fit
        geometry.computeBoundingBox();
        const box = geometry.boundingBox;
        const center = box.getCenter(new THREE.Vector3());
        currentMesh.position.sub(center);

        const size = box.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);
        const dist = maxDim * 2;
        camera.position.set(dist * 0.7, dist * 0.5, dist);
        camera.lookAt(0, 0, 0);
        controls.target.set(0, 0, 0);
        controls.update();

        // Update info
        const tris = geometry.index ? geometry.index.count / 3 : geometry.attributes.position.count / 3;
        fileName.textContent = name;
        fileSize.textContent = `${size.x.toFixed(1)} Ã— ${size.y.toFixed(1)} Ã— ${size.z.toFixed(1)} mm`;
        fileTris.textContent = Math.round(tris).toLocaleString();
        status.textContent = 'âœ“ Loaded successfully';

      } catch (error) {
        console.error('Load error:', error);
        status.textContent = `Failed: ${error.message}`;
        fileName.textContent = '-';
        fileSize.textContent = '-';
        fileTris.textContent = '-';
      }
    }

    // Auto-load first file on scan
    const originalScanFolder = scanFolder;
    scanFolder = async function() {
      await originalScanFolder();
      // Auto-click first file if any
      const firstFile = fileList.querySelector('.file-item');
      if (firstFile) {
        setTimeout(() => firstFile.click(), 300);
      }
    };

    // Resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Animation
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // Auto-scan on load
    scanFolder();
  </script>
</body>
</html>
