<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fasteners STL Viewer — Socket & Hex</title>
  <style>
    :root{
      --bg:#0f1220; --fg:#e6e7ee; --muted:#9aa3b2; --accent:#6ea8fe; --card:#171a2b; --border:#2a2f45;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);}
    header{display:flex;align-items:center;gap:1rem;padding:1rem;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#11152a,#0f1220);position:sticky;top:0;z-index:10}
    header h1{font-size:1rem;margin:0;color:#c7d2fe;font-weight:600;letter-spacing:.3px}
    .controls{display:grid;grid-template-columns:repeat(6,minmax(110px,1fr));gap:.5rem;width:100%}
    .control{background:var(--card);border:1px solid var(--border);padding:.6rem .7rem;border-radius:.8rem}
    .control label{display:block;font-size:.73rem;color:var(--muted);margin-bottom:.25rem}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    select,button,input[type="checkbox"]{width:100%;padding:.5rem;border-radius:.5rem;border:1px solid var(--border);background:#0c0f1d;color:var(--fg);outline:none}
    button{cursor:pointer;font-weight:600;background:#1b2240;border-color:#2b3561}
    button:hover{background:#22305c}
    .status{font-size:.8rem;color:var(--muted)}
    #viewer{position:fixed;inset:80px 0 0 0}
    .panel{position:fixed;right:12px;bottom:12px;background:var(--card);border:1px solid var(--border);padding:.7rem .8rem;border-radius:.8rem;font-size:.85rem;min-width:260px;max-width:360px}
    .panel h3{margin:.1rem 0 .5rem 0;font-size:.9rem;color:#b6c4ff}
    .panel .kv{display:flex;justify-content:space-between;margin:.18rem 0;color:#cdd6f4}
    .panel .kv span:first-child{color:var(--muted)}
    .small{font-size:.75rem;color:var(--muted)}
    .dropzone{grid-column:span 6;display:flex;align-items:center;justify-content:center;padding:.7rem;border:1px dashed #405088;border-radius:.7rem;background:#12162a;color:#9fb3ff}
    .link{color:#9ec1ff;text-decoration:none;border-bottom:1px dashed #496fb6}
    @media (max-width:1100px){ .controls{grid-template-columns:repeat(3,minmax(120px,1fr));} #viewer{inset:120px 0 0 0;} }
    @media (max-width:700px){ .controls{grid-template-columns:repeat(2,minmax(140px,1fr));} #viewer{inset:160px 0 0 0;} }
  </style>
</head>
<body>
  <header>
    <h1>Fasteners STL Viewer — Socket Head (ISO 4762) &amp; Hex Head (ISO 4014)</h1>
    <div class="controls">
      <div class="control">
        <label>Head Type</label>
        <div class="row">
          <select id="headType">
            <option value="socket">Socket Head — ISO 4762</option>
            <option value="hex">Hex Head — ISO 4014</option>
          </select>
        </div>
      </div>
      <div class="control">
        <label>Diameter (M)</label>
        <select id="diameter"></select>
      </div>
      <div class="control">
        <label>Length (mm)</label>
        <select id="length"></select>
      </div>
      <div class="control">
        <label>View</label>
        <div class="row">
          <label class="small"><input type="checkbox" id="showGrid" checked> Grid</label>
          <label class="small"><input type="checkbox" id="showAxes" checked> Axes</label>
          <label class="small"><input type="checkbox" id="autoRotate"> Auto-rotate</label>
        </div>
      </div>
      <div class="control">
        <label>Actions</label>
        <div class="row">
          <button id="btnLoad">Load Model</button>
          <button id="btnReset">Reset View</button>
        </div>
        <div id="status" class="status">Ready.</div>
      </div>
      <div class="control dropzone" id="dropzone">
        Drop a local STL here (optional) — overrides selection
      </div>
    </div>
  </header>

  <div id="viewer"></div>

  <div class="panel" id="infoPanel">
    <h3>Model Info</h3>
    <div class="kv"><span>File</span><span id="kvFile">—</span></div>
    <div class="kv"><span>Size (mm)</span><span id="kvSize">—</span></div>
    <div class="kv"><span>Bounding Sphere R</span><span id="kvRadius">—</span></div>
    <div class="kv"><span>Triangles</span><span id="kvTris">—</span></div>
    <div class="small">Tip: host this HTML in the same GitHub repo and keep STL folders relative for zero-CORS pain.</div>
  </div>

  <!-- three.js + loaders (module build) -->
  <script type="module">
    // ======= CONFIG — update these to match your repo layout =======
    // If this HTML is at the repo root and folders are beside it, these defaults work.
    const PATHS = {
      socket: "./Socket_Head/ISO4762/STL/",
      hex: "./Hex_Head/ISO4014/STL/"
    };
    // File name patterns your generator used:
    const NAME_PATTERNS = {
      socket: ({M, L}) => `SocketHead_M${M}x${L}_ISO4762.stl`,
      hex:    ({M, L}) => `HexHead_M${M}x${L}_ISO4014.stl`
    };
    // Which diameters to show:
    const DIAMS = ["3","4","5","6","8","10","12","16","20","24"];
    // Common usable lengths (mm). Your STL set might not include every combo; 404s are handled gracefully.
    const LENGTHS = [6,8,10,12,14,16,20,25,30,35,40,45,50,55,60];

    // ======= UI =======
    const $ = (s)=>document.querySelector(s);
    const headTypeSel = $("#headType");
    const diamSel = $("#diameter");
    const lenSel = $("#length");
    const showGrid = $("#showGrid");
    const showAxes = $("#showAxes");
    const autoRotate = $("#autoRotate");
    const btnLoad = $("#btnLoad");
    const btnReset = $("#btnReset");
    const statusEl = $("#status");
    const kvFile = $("#kvFile");
    const kvSize = $("#kvSize");
    const kvRadius = $("#kvRadius");
    const kvTris = $("#kvTris");
    const dropzone = $("#dropzone");

    function fillSelect(sel, items, fmt=(x)=>x){
      sel.innerHTML = "";
      items.forEach(v=>{
        const opt = document.createElement("option");
        opt.value = String(v);
        opt.textContent = fmt(v);
        sel.appendChild(opt);
      });
    }
    fillSelect(diamSel, DIAMS, d=>"M"+d);
    fillSelect(lenSel, LENGTHS);

    // ======= Three.js setup =======
    import * as THREE from "https://unpkg.com/three@0.161.0/build/three.module.js";
    import {OrbitControls} from "https://unpkg.com/three@0.161.0/examples/jsm/controls/OrbitControls.js";
    import {STLLoader} from "https://unpkg.com/three@0.161.0/examples/jsm/loaders/STLLoader.js";

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setClearColor(0x0b0e1a, 1);
    $("#viewer").appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 5000);
    camera.position.set(160, 140, 180);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.target.set(0,0,0);

    // Lights
    const amb = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(amb);
    const key = new THREE.DirectionalLight(0xffffff, 1.0);
    key.position.set(2,3,4);
    scene.add(key);
    const rim = new THREE.DirectionalLight(0xffffff, 0.6);
    rim.position.set(-3,2,-2);
    scene.add(rim);

    // Helpers
    const grid = new THREE.GridHelper(400, 40, 0x335, 0x223);
    grid.visible = showGrid.checked;
    scene.add(grid);
    const axes = new THREE.AxesHelper(80);
    axes.visible = showAxes.checked;
    scene.add(axes);

    showGrid.addEventListener("change", ()=>grid.visible = showGrid.checked);
    showAxes.addEventListener("change", ()=>axes.visible = showAxes.checked);
    autoRotate.addEventListener("change", ()=>controls.autoRotate = autoRotate.checked);

    let mesh = null;
    const loader = new STLLoader();

    function setStatus(msg){ statusEl.textContent = msg; }
    function clearModel(){
      if(mesh){
        scene.remove(mesh);
        mesh.geometry.dispose();
        if(mesh.material && mesh.material.dispose) mesh.material.dispose();
        mesh = null;
      }
    }

    function human(n, digits=2){
      if(n === 0) return "0";
      const a = Math.abs(n);
      if(a>=1000) return (n/1000).toFixed(digits)+"k";
      return n.toFixed(digits);
    }

    function fitCameraToObject(obj){
      obj.geometry.computeBoundingSphere();
      obj.geometry.computeBoundingBox();
      const bs = obj.geometry.boundingSphere;
      const bb = obj.geometry.boundingBox;

      const size = new THREE.Vector3();
      bb.getSize(size);
      kvSize.textContent = `${size.x.toFixed(2)} × ${size.y.toFixed(2)} × ${size.z.toFixed(2)}`;
      kvRadius.textContent = bs.radius.toFixed(2);

      // center
      const center = bs.center.clone();
      obj.position.sub(center);

      // distance for framing
      const fov = camera.fov * (Math.PI/180);
      let dist = bs.radius / Math.sin(fov/2);
      dist *= 1.3; // a little padding

      camera.near = Math.max(0.1, dist/100);
      camera.far = dist*10;
      camera.updateProjectionMatrix();
      camera.position.copy(new THREE.Vector3(dist, dist*0.7, dist));
      controls.target.set(0,0,0);
      controls.update();
    }

    async function loadFromURL(url, label){
      setStatus("Loading …");
      clearModel();
      try{
        const geo = await new Promise((resolve, reject)=>{
          loader.load(url, resolve, (xhr)=>{
            const pct = xhr.total ? (xhr.loaded/xhr.total*100).toFixed(1) : "…";
            setStatus(`Loading ${pct}%`);
          }, (err)=>reject(err));
        });
        const mat = new THREE.MeshStandardMaterial({color:0xcfd8ff, metalness:0.15, roughness:0.6});
        mesh = new THREE.Mesh(geo, mat);
        // Flip Y if needed? STL is usually already fine. Keep as-is.
        scene.add(mesh);
        fitCameraToObject(mesh);

        // triangles
        let tris = 0;
        if(geo.index){ tris = geo.index.count/3; } else { tris = geo.attributes.position.count/3; }
        kvTris.textContent = human(tris, 0);
        kvFile.textContent = label;
        setStatus("Loaded.");
      }catch(e){
        console.error(e);
        setStatus("Failed to load. " + (e?.message || ""));
        kvFile.textContent = "—";
        kvSize.textContent = "—";
        kvRadius.textContent = "—";
        kvTris.textContent = "—";
      }
    }

    function buildURL(){
      const type = headTypeSel.value; // 'socket' | 'hex'
      const M = diamSel.value;
      const L = lenSel.value;
      const name = NAME_PATTERNS[type]({M, L});
      const url = PATHS[type] + name;
      return {url, label:name};
    }

    btnLoad.addEventListener("click", ()=>{
      const {url, label} = buildURL();
      loadFromURL(url, label);
    });

    btnReset.addEventListener("click", ()=>{
      controls.reset();
      controls.target.set(0,0,0);
      controls.update();
    });

    // Drag & drop local STL
    ;["dragenter","dragover","dragleave","drop"].forEach(evt=>{
      dropzone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); }, false);
    });
    dropzone.addEventListener("dragover", ()=>dropzone.style.borderColor="#6ea8fe");
    dropzone.addEventListener("dragleave", ()=>dropzone.style.borderColor="#405088");
    dropzone.addEventListener("drop", (e)=>{
      dropzone.style.borderColor="#405088";
      const file = e.dataTransfer.files?.[0];
      if(!file || !file.name.toLowerCase().endsWith(".stl")){ setStatus("Drop an .stl file"); return; }
      kvFile.textContent = file.name + " (local)";
      const reader = new FileReader();
      reader.onload = ()=>{
        clearModel();
        const geo = loader.parse(reader.result);
        const mat = new THREE.MeshStandardMaterial({color:0xcfd8ff, metalness:0.15, roughness:0.6});
        mesh = new THREE.Mesh(geo, mat);
        scene.add(mesh);
        fitCameraToObject(mesh);
        let tris = 0;
        if(geo.index){ tris = geo.index.count/3; } else { tris = geo.attributes.position.count/3; }
        kvTris.textContent = human(tris, 0);
        setStatus("Loaded local file.");
      };
      reader.readAsArrayBuffer(file);
    });

    // Initial load
    (function init(){
      headTypeSel.value = "socket";
      diamSel.value = "6";
      lenSel.value = "20";
      const {url, label} = buildURL();
      loadFromURL(url, label);
    })();

    // Resize
    window.addEventListener("resize", ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Animate
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
