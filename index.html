<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fasteners STL Viewer — Socket & Hex</title>

  <!-- Basic, clean styles -->
  <style>
    :root{
      --bg:#0b1020;
      --panel:#121a33;
      --text:#e9eefc;
      --muted:#9fb2db;
      --accent:#6aa6ff;
      --border:#2b3962;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    header {
      position: sticky; top: 0;
      background: linear-gradient(180deg, rgba(18,26,51,0.98), rgba(18,26,51,0.85));
      border-bottom: 1px solid var(--border);
      z-index: 100;
    }
    .shell { max-width: 1100px; margin: 0 auto; padding: 14px 18px; }

    .toolbar {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 12px;
      align-items: end;
      overflow: visible !important; /* prevent clipping */
    }
    .field { display: grid; gap: 6px; }
    label { font-size: 12px; color: var(--muted); }

    select, button {
      background: #0b1430;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
    }
    select:focus, button:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(106,166,255,0.25); }
    button { cursor: pointer; }
    button.primary { background: var(--accent); color: #081025; border-color: #5e93e0; }

    main { padding: 18px; }
    .viewer-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.35);
      overflow: hidden; /* but we won't clip menus in header */
    }

    .viewer-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; border-bottom: 1px solid var(--border); }
    .viewer-title { font-weight: 600; }
    .meta { color: var(--muted); font-size: 13px; }

    #canvas-wrap { position: relative; width: 100%; height: 64vh; min-height: 420px; background: radial-gradient(ellipse at top, #101839, #0b1228); }
    #stl-canvas { width: 100%; height: 100%; display: block; }

    .statusbar { display: flex; justify-content: space-between; padding: 10px 14px; border-top: 1px solid var(--border); gap: 8px; flex-wrap: wrap; }
    .status { color: var(--muted); }
    .links { display: flex; gap: 10px; align-items: center; }

    .spinner {
      position: absolute; inset: 0; display: none; align-items: center; justify-content: center;
      background: linear-gradient(180deg, rgba(9,13,26,0.0), rgba(9,13,26,0.15));
      z-index: 5;
    }
    .spinner.on { display: flex; }
    .spinner::after {
      content: "";
      width: 28px; height: 28px; border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.2);
      border-top-color: rgba(255,255,255,0.9);
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Dropdown unclipping fixes (preemptively avoid cut-off menus) */
    html, body { overflow: auto; }
    header, main, .container, .shell, .toolbar, .viewer-card {
      overflow: visible !important;
      transform: none !important; /* avoid new stacking contexts on toolbar */
    }
    select { position: relative; z-index: 10; } /* keep above the card edge */
    /* end unclipping */

    @media (max-width: 860px) {
      .toolbar { grid-template-columns: 1fr 1fr; grid-auto-rows: auto; }
      .viewer-header { flex-direction: column; align-items: flex-start; gap: 6px; }
      #canvas-wrap { height: 60vh; }
    }
  </style>

  <!-- three.js + helpers (CDN) -->
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/loaders/STLLoader.js"></script>
</head>
<body>
  <header>
    <div class="shell">
      <div class="toolbar">
        <div class="field">
          <label for="family">Family</label>
          <select id="family">
            <option value="socket">Socket Head (ISO 4762)</option>
            <option value="hex">Hex Head (ISO 4017 / DIN 933)</option>
          </select>
        </div>
        <div class="field">
          <label for="diam">Diameter</label>
          <select id="diam"></select>
        </div>
        <div class="field">
          <label for="len">Length (mm)</label>
          <select id="len"></select>
        </div>
        <div class="field">
          <button id="openBtn" class="primary">Open model</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="shell">
      <div class="viewer-card">
        <div class="viewer-header">
          <div class="viewer-title" id="title">—</div>
          <div class="meta" id="meta">Pick a size to load the STL.</div>
        </div>
        <div id="canvas-wrap">
          <div class="spinner" id="spinner"></div>
          <canvas id="stl-canvas"></canvas>
        </div>
        <div class="statusbar">
          <div class="status" id="status">Ready.</div>
          <div class="links">
            <a id="dl" href="#" download>Download STL</a>
            <span id="filesize" class="meta"></span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ---- Configuration (edit paths/patterns if your repo structure differs) ---- //
    const CONFIG = {
      socket: {
        label: "Socket Head (ISO 4762)",
        folder: "Bolts/Socket_Head/ISO4762/STL",
        filename: (d, L) => `SocketHead_M${d}x${L}_ISO4762.stl`
      },
      hex: {
        label: "Hex Head (ISO 4017 / DIN 933)",
        folder: "Bolts/Hex_Head/ISO4017/STL",
        filename: (d, L) => `HexHead_M${d}x${L}_ISO4017.stl`
      }
    };

    // A sane, low-404 length set per diameter up to 60 mm
    const LENGTHS_PER_DIAM = {
      "3":  [6,8,10,12,16,20,25,30],
      "4":  [8,10,12,16,20,25,30,35,40],
      "5":  [10,12,16,20,25,30,35,40,45,50],
      "6":  [10,12,16,20,25,30,35,40,45,50,55,60],
      "8":  [12,16,20,25,30,35,40,45,50,55,60],
      "10": [16,20,25,30,35,40,45,50,60],
      "12": [20,25,30,35,40,45,50,60],
      "16": [30,35,40,45,50,60],
      "20": [35,40,45,50,60],
      "24": [40,45,50,60]
    };

    // Exposed diameters
    const DIAMS = Object.keys(LENGTHS_PER_DIAM).map(Number).sort((a,b)=>a-b);

    // ---- Populate selects ---- //
    const $family = document.getElementById('family');
    const $diam   = document.getElementById('diam');
    const $len    = document.getElementById('len');
    const $open   = document.getElementById('openBtn');

    function populateDiam() {
      $diam.innerHTML = "";
      for (const d of DIAMS) {
        const opt = document.createElement('option');
        opt.value = String(d);
        opt.textContent = `M${d}`;
        $diam.appendChild(opt);
      }
    }
    function populateLen(d) {
      $len.innerHTML = "";
      (LENGTHS_PER_DIAM[d] || []).forEach(L => {
        const opt = document.createElement('option');
        opt.value = String(L);
        opt.textContent = L;
        $len.appendChild(opt);
      });
    }

    populateDiam();
    populateLen(String(DIAMS[0]));

    $diam.addEventListener('change', () => populateLen($diam.value));

    // ---- three.js viewer setup ---- //
    let scene, camera, renderer, controls, currentMesh;
    const $canvas = document.getElementById('stl-canvas');
    const $wrap   = document.getElementById('canvas-wrap');
    const $spin   = document.getElementById('spinner');
    const $status = document.getElementById('status');
    const $title  = document.getElementById('title');
    const $meta   = document.getElementById('meta');
    const $dl     = document.getElementById('dl');
    const $size   = document.getElementById('filesize');

    function init3D() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b1020);

      const w = $wrap.clientWidth;
      const h = $wrap.clientHeight;

      camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 2000);
      camera.position.set(0, 0, 150);

      renderer = new THREE.WebGLRenderer({ canvas: $canvas, antialias: true });
      renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
      renderer.setSize(w, h);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      const hemi = new THREE.HemisphereLight(0xffffff, 0x3b4a7a, 0.5);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(80,120,100);
      scene.add(dir);

      animate();
      window.addEventListener('resize', onResize);
    }
    function onResize() {
      const w = $wrap.clientWidth;
      const h = $wrap.clientHeight;
      camera.aspect = w/h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    }
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    function setLoading(on, msg="") {
      $spin.classList.toggle('on', on);
      $status.textContent = msg || (on ? "Loading…" : "Ready.");
    }

    function fitCameraTo(obj) {
      obj.geometry.computeBoundingBox();
      const bb = obj.geometry.boundingBox;
      const size = new THREE.Vector3();
      bb.getSize(size);
      const center = new THREE.Vector3();
      bb.getCenter(center);

      obj.position.sub(center); // center mesh
      const maxDim = Math.max(size.x, size.y, size.z);
      const dist = maxDim * 1.6;
      camera.position.set(dist, dist, dist);
      camera.near = dist / 50;
      camera.far  = dist * 50;
      camera.lookAt(0,0,0);
      camera.updateProjectionMatrix();
      controls.target.set(0,0,0);
      controls.update();
    }

    async function headSize(url) {
      try {
        const r = await fetch(url, { method: 'HEAD' });
        if (!r.ok) return null;
        const len = r.headers.get('content-length');
        return len ? Number(len) : null;
      } catch(e) {
        return null;
      }
    }

    const loader = new THREE.STLLoader();
    async function loadSTL(url, label) {
      setLoading(true, "Loading STL…");
      // clear any existing mesh
      if (currentMesh) {
        scene.remove(currentMesh);
        currentMesh.geometry.dispose();
        currentMesh.material.dispose();
        currentMesh = null;
      }
      try {
        // small HEAD check for nicer size display (optional)
        const size = await headSize(url);
        $size.textContent = size ? `~${(size/1024).toFixed(0)} KB` : "";
        $dl.href = url;
        $dl.download = label + ".stl";

        await new Promise((resolve, reject)=>{
          loader.load(url, geo => {
            const mat = new THREE.MeshStandardMaterial({ color: 0xaec9ff, metalness: 0.1, roughness: 0.4 });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            currentMesh = mesh;
            scene.add(mesh);
            fitCameraTo(mesh);
            resolve();
          }, undefined, reject);
        });

        $title.textContent = label;
        $meta.textContent = url;
        setLoading(false, "Loaded.");
      } catch (err) {
        console.error(err);
        setLoading(false, "Could not load STL (404 or network).");
        $meta.textContent = "Not found: " + url;
        $size.textContent = "";
      }
    }

    function currentUrl() {
      const fam = $family.value;
      const d = $diam.value;
      const L = $len.value;
      const cfg = CONFIG[fam];
      const file = cfg.filename(d, L);
      // assume index.html at repo root; adjust if index in subfolder
      const url = `${cfg.folder}/${file}`;
      return { url, label: file.replace(/\.stl$/i,"") };
    }

    // Bind UI
    $open.addEventListener('click', ()=>{
      const {url, label} = currentUrl();
      loadSTL(url, label);
    });

    // Auto-load a sensible default
    init3D();
    (function boot(){
      $family.value = "socket";
      $diam.value = "6";
      populateLen("6");
      $len.value = "20";
      const {url, label} = currentUrl();
      loadSTL(url, label);
    })();
  </script>
</body>
</html>
