<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Fasteners Viewer â€” Nima</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#0e1116;--panel:#161a22;--text:#e6eaf2;--muted:#9aa3b2;--accent:#6ea8fe;--line:#232837;
      --chip:#1f2532;--chip-text:#dbe4ff;--ok:#46d37a;--warn:#f8c35e;
    }
    .light{
      --bg:#ffffff;--panel:#f7f9fc;--text:#0c1321;--muted:#5a667a;--accent:#2563eb;--line:#e5e9f2;
      --chip:#eef2f8;--chip-text:#0c1321;--ok:#0ea965;--warn:#b7791f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); display:flex; flex-direction:column; font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex; align-items:center; justify-content:space-between; padding:10px 14px; border-bottom:1px solid var(--line); background:var(--panel)}
    header .brand{display:flex; gap:10px; align-items:center; font-weight:700}
    header .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent)}
    header .actions{display:flex; gap:10px; align-items:center}
    .btn{border:1px solid var(--line); background:transparent; color:var(--text); padding:6px 10px; border-radius:10px; cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    main{flex:1; display:grid; grid-template-columns:320px 1fr; min-height:0}
    aside{border-right:1px solid var(--line); background:var(--panel); padding:14px; overflow:auto}
    .field{margin-bottom:12px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    select,input[type="text"]{width:100%; padding:8px 10px; background:#0000; border:1px solid var(--line); color:var(--text); border-radius:8px; outline:none}
    select:focus,input:focus{border-color:var(--accent)}
    .chips{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
    .chip{background:var(--chip); color:var(--chip-text); padding:4px 8px; border-radius:999px; font-size:12px}
    .note{color:var(--muted); font-size:12px; margin-top:6px}

    .viewer-wrap{position:relative}
    canvas#viewer{position:absolute; inset:0; width:100%; height:100%}
    .overlay{position:absolute; top:10px; right:10px; display:flex; gap:10px}
    .tag{padding:4px 8px; border-radius:8px; background:var(--chip); font-size:12px; color:var(--chip-text); border:1px solid var(--line)}
    .card{position:absolute; left:10px; bottom:10px; background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:10px; max-width:420px}
    .card h3{margin:0 0 6px 0; font-size:14px}
    .kv{display:grid; grid-template-columns:110px 1fr; gap:6px; font-size:13px}
    .row{display:flex; gap:8px; margin-top:8px}
    .link{color:var(--accent); text-decoration:none; border:1px solid var(--line); padding:6px 10px; border-radius:8px}
    .link:hover{border-color:var(--accent)}
    .spinner{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none}
    .spinner .s{width:32px; height:32px; border:3px solid var(--line); border-top-color:var(--accent); border-radius:50%; animation:spin 0.9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width: 900px){main{grid-template-columns:1fr; grid-template-rows:auto 1fr} aside{border-right:none; border-bottom:1px solid var(--line)}}
  </style>
</head>
<body class="light">
  <header>
    <div class="brand"><div class="dot"></div> Fasteners Viewer</div>
    <div class="actions">
      <button id="theme" class="btn" title="Toggle theme">ðŸŒ— Theme</button>
      <a class="btn" href="https://github.com" target="_blank" rel="noopener">GitHub</a>
    </div>
  </header>

  <main>
    <aside>
      <div class="field">
        <label>Search</label>
        <input id="search" type="text" placeholder="Type to filter (e.g. M8, ISO4035, nut)â€¦">
      </div>

      <div class="field">
        <label>Family</label>
        <select id="family"></select>
      </div>

      <div class="field">
        <label>Type</label>
        <select id="subtype"></select>
      </div>

      <div class="field">
        <label>Standard</label>
        <select id="standard"></select>
      </div>

      <div class="field">
        <label>Diameter</label>
        <select id="diameter"></select>
      </div>

      <div class="chips" id="chips"></div>
      <div class="note">Drag = rotate Â· Wheel = zoom Â· Right-drag = pan</div>
    </aside>

    <section class="viewer-wrap">
      <div class="spinner" id="spin" hidden><div class="s"></div></div>
      <div class="overlay">
        <div class="tag" id="tagCount">0 items</div>
        <div class="tag" id="tagSize">â€”</div>
      </div>
      <canvas id="viewer"></canvas>

      <div class="card" id="info">
        <h3 id="title">â€”</h3>
        <div class="kv">
          <div>Family</div><div id="iFamily">â€”</div>
          <div>Type</div><div id="iSubtype">â€”</div>
          <div>Standard</div><div id="iStandard">â€”</div>
          <div>Diameter</div><div id="iDiameter">â€”</div>
          <div>Span (mm)</div><div id="iSpan">â€”</div>
        </div>
        <div class="row">
          <a id="dlSTL" class="link" download>â¬‡ STL</a>
          <a id="dlSTEP" class="link" download>â¬‡ STEP</a>
        </div>
      </div>
    </section>
  </main>

  <!-- CSV parser -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Three.js + STLLoader -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/loaders/STLLoader.js"></script>

  <script type="module">
    // ====== EDIT THIS LIST: add your manifest CSVs here (relative paths in your repo) ======
    const MANIFESTS = [
      // example: Hex Thin nuts (your successful run)
      "FastenersLib/Nuts/Hex_Thin/ISO4035/manifest_Hex_Thin_ISO4035.csv",
      // add more as you generate them:
      // "FastenersLib/Nuts/Hex/DIN934/manifest_Hex_DIN934.csv",
      // "FastenersLib/Nuts/Flange/ISO4161/manifest_Flange_ISO4161.csv",
      // "FastenersLib/Bolts/Socket_Head/ISO4762/manifest_Socket_Head_ISO4762.csv",
    ];

    // ====== UI elements ======
    const el = {
      theme:  document.getElementById('theme'),
      search: document.getElementById('search'),
      family: document.getElementById('family'),
      subtype:document.getElementById('subtype'),
      standard:document.getElementById('standard'),
      diameter:document.getElementById('diameter'),
      chips:  document.getElementById('chips'),
      tagCount:document.getElementById('tagCount'),
      tagSize: document.getElementById('tagSize'),
      title:  document.getElementById('title'),
      iFamily:document.getElementById('iFamily'),
      iSubtype:document.getElementById('iSubtype'),
      iStandard:document.getElementById('iStandard'),
      iDiameter:document.getElementById('iDiameter'),
      iSpan:   document.getElementById('iSpan'),
      dlSTL:   document.getElementById('dlSTL'),
      dlSTEP:  document.getElementById('dlSTEP'),
      spin:    document.getElementById('spin'),
      canvas:  document.getElementById('viewer'),
    };

    // ====== Three.js scene ======
    const renderer = new THREE.WebGLRenderer({ canvas: el.canvas, antialias:true });
    let scene, camera, controls, current;
    function init3D(){
      resize();
      scene = new THREE.Scene();
      scene.background = new THREE.Color(getComputedStyle(document.body).getPropertyValue('--panel'));

      camera = new THREE.PerspectiveCamera(45, el.canvas.clientWidth/el.canvas.clientHeight, 0.1, 5000);
      camera.position.set(140,110,160);

      controls = new (await import('https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js')).OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      scene.add(new THREE.HemisphereLight(0xffffff,0x303030,0.9));
      const d = new THREE.DirectionalLight(0xffffff,0.9); d.position.set(100,120,80); scene.add(d);

      requestAnimationFrame(tick);
      window.addEventListener('resize', resize);
    }
    function resize(){
      const w = el.canvas.clientWidth || el.canvas.parentElement.clientWidth;
      const h = el.canvas.clientHeight || el.canvas.parentElement.clientHeight;
      renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
      renderer.setSize(w,h,false);
      if(camera){ camera.aspect = w/h; camera.updateProjectionMatrix(); }
    }
    function tick(){ controls && controls.update(); renderer.render(scene,camera); requestAnimationFrame(tick); }

    const loader = new THREE.STLLoader();
    async function showSTL(url){
      el.spin.hidden = false;
      // clean old
      if(current){ scene.remove(current); current.geometry.dispose(); current.material.dispose(); current=null; }
      const geo = await new Promise((res,rej)=> loader.load(url, res, undefined, rej));
      geo.computeVertexNormals();
      const mat = new THREE.MeshStandardMaterial({ color:0x7a7f86, metalness:.4, roughness:.6 });
      const mesh = new THREE.Mesh(geo, mat);
      geo.computeBoundingBox();
      const bb = geo.boundingBox;
      const center = new THREE.Vector3().addVectors(bb.min, bb.max).multiplyScalar(0.5);
      geo.translate(-center.x, -center.y, -center.z);
      scene.add(mesh);
      current = mesh;

      // fit camera
      const size = new THREE.Vector3().subVectors(bb.max, bb.min);
      const maxDim = Math.max(size.x,size.y,size.z);
      el.tagSize.textContent = `${maxDim.toFixed(1)} mm max span`;
      const dist = maxDim*2.0 + 20;
      camera.position.set(dist, dist*0.75, dist);
      controls.target.set(0,0,0); controls.update();
      el.spin.hidden = true;
    }

    // ====== Data loading & mapping ======
    function windowsPathToRepo(path){
      // If already relative, return as-is.
      if(/^\.{0,2}\//.test(path) || path.startsWith('FastenersLib/')) return path;
      const m = path.match(/(Nuts|Bolts|Washers|Screws|Rivets|Pins)[\\\/].*$/i);
      if(!m) return path;
      return "FastenersLib/" + m[0].replace(/\\/g,'/');
    }

    async function loadCSVs(){
      const rows = [];
      for(const url of MANIFESTS){
        const res = await fetch(url);
        const txt = await res.text();
        const parsed = Papa.parse(txt, {header:true, skipEmptyLines:true});
        for(const r of parsed.data){
          if(!r.family || !r.subtype || !r.standard || !r.diameter) continue;
          r.path_stl  = r.path_stl  ? windowsPathToRepo(r.path_stl)  : "";
          r.path_step = r.path_step ? windowsPathToRepo(r.path_step) : "";
          rows.push(r);
        }
      }
      return rows;
    }

    // build â†’ Family â†’ Subtype â†’ Standard â†’ Diameter â†’ [rows]
    function buildIndex(rows){
      const idx = new Map();
      for(const r of rows){
        const fam = r.family.trim();
        const sub = r.subtype.trim();
        const std = r.standard.trim();
        const dia = r.diameter.trim();

        if(!idx.has(fam)) idx.set(fam, new Map());
        const m1 = idx.get(fam);
        if(!m1.has(sub)) m1.set(sub, new Map());
        const m2 = m1.get(sub);
        if(!m2.has(std)) m2.set(std, new Map());
        const m3 = m2.get(std);
        if(!m3.has(dia)) m3.set(dia, []);
        m3.get(dia).push(r);
      }
      return idx;
    }

    function fillSelect(sel, items){
      sel.innerHTML = "";
      for(const it of items){
        const opt=document.createElement('option');
        opt.value=it; opt.textContent=it; sel.appendChild(opt);
      }
    }

    function updateChips(){
      el.chips.innerHTML="";
      const add = t=>{const c=document.createElement('div'); c.className='chip'; c.textContent=t; el.chips.appendChild(c);}
      add(el.family.value||"â€”");
      add(el.subtype.value||"â€”");
      add(el.standard.value||"â€”");
      add(el.diameter.value||"â€”");
    }

    function updateInfo(row){
      const title = row.name_stem || `${row.family} ${row.subtype} ${row.standard} ${row.diameter}`;
      el.title.textContent = title;
      el.iFamily.textContent   = row.family;
      el.iSubtype.textContent  = row.subtype;
      el.iStandard.textContent = row.standard;
      el.iDiameter.textContent = row.diameter;
      el.iSpan.textContent     = row.measured_max_span_mm || "â€”";
      el.dlSTL.href  = row.path_stl || "#";
      el.dlSTEP.href = row.path_step || "#";
    }

    function filterRows(rows, query){
      if(!query) return rows;
      const q = query.toLowerCase();
      return rows.filter(r =>
        (r.family||"").toLowerCase().includes(q) ||
        (r.subtype||"").toLowerCase().includes(q) ||
        (r.standard||"").toLowerCase().includes(q) ||
        (r.diameter||"").toLowerCase().includes(q) ||
        (r.name_stem||"").toLowerCase().includes(q)
      );
    }

    // ====== Boot ======
    let ALL = [], INDEX = null;

    function refreshSelectors(){
      const fams = [...INDEX.keys()].sort();
      fillSelect(el.family, fams);
      refreshSubtype();
    }
    function refreshSubtype(){
      const m1 = INDEX.get(el.family.value) || new Map();
      fillSelect(el.subtype, [...m1.keys()].sort());
      refreshStandard();
    }
    function refreshStandard(){
      const m2 = (INDEX.get(el.family.value) || new Map()).get(el.subtype.value) || new Map();
      fillSelect(el.standard, [...m2.keys()].sort());
      refreshDiameter();
    }
    function refreshDiameter(){
      const m3 = ((INDEX.get(el.family.value)||new Map()).get(el.subtype.value)||new Map()).get(el.standard.value) || new Map();
      fillSelect(el.diameter, [...m3.keys()].sort());
      updateChips();
      showCurrent();
    }

    function showCurrent(){
      // rows at the chosen leaf
      const rows = ((INDEX.get(el.family.value)||new Map())
                   .get(el.subtype.value)||new Map())
                   .get(el.standard.value) || new Map();

      const list = rows.get(el.diameter.value) || [];
      el.tagCount.textContent = `${list.length} items`;

      if(!list.length) return;

      // pick the first row (you can expand to list multiple variants later)
      const row = list[0];
      updateInfo(row);
      if(row.path_stl){
        showSTL(row.path_stl).catch(err=>{
          console.error(err);
          alert("Failed to load STL. Check that the path exists in the repo.");
        });
      }
    }

    // events
    el.family.addEventListener('change', refreshSubtype);
    el.subtype.addEventListener('change', refreshStandard);
    el.standard.addEventListener('change', refreshDiameter);
    el.diameter.addEventListener('change', showCurrent);
    el.search.addEventListener('input', ()=>{
      const filtered = filterRows(ALL, el.search.value);
      INDEX = buildIndex(filtered);
      refreshSelectors();
    });
    el.theme.addEventListener('click', ()=>{
      document.body.classList.toggle('light');
      resize();
    });

    // Go
    (async function start(){
      await init3D();
      ALL = await loadCSVs();
      if(!ALL.length){ alert("No data rows found. Check MANIFESTS paths."); return; }
      INDEX = buildIndex(ALL);
      refreshSelectors();
    })();
  </script>
</body>
</html>
