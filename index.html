<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<<<<<<< HEAD
  <title>Fasteners STL Viewer â€” GitHub-backed</title>
  <style>
    :root {
      --bg: #0f1115;
      --card: #151823;
      --text: #e7ecf1;
      --muted: #9aa4b2;
      --accent: #6aa6ff;
      --danger: #ff6a6a;
      --ok: #66d19e;
      --border: #23283a;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100%;
    }
    header {
      border-bottom: 1px solid var(--border);
      padding: 10px 14px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      background: #0e1220;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .title {
      font-weight: 700;
      letter-spacing: .2px;
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(5, minmax(120px, 1fr)) auto;
      gap: 8px;
      width: 100%;
    }
    select, button, input[type="text"] {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
    }
    select:focus, button:focus, input[type="text"]:focus {
      outline: 2px solid var(--accent);
      outline-offset: 1px;
    }
    button {
      cursor: pointer;
      white-space: nowrap;
    }
    .status {
      font-size: 13px;
      color: var(--muted);
      margin-left: 8px;
    }
    main {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 14px;
      padding: 14px;
      height: calc(100vh - 58px);
      box-sizing: border-box;
    }
    .viewer-card, .info-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 0;
    }
    .viewer-card header, .info-card header {
      background: #0f1424;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      letter-spacing: .2px;
    }
    #viewer {
      position: relative;
      min-height: 0;
    }
    #stage {
      width: 100%;
      height: 100%;
      display: block;
      background: linear-gradient(180deg, #0f1115 0%, #0f1115 60%, #0b0d12 100%);
    }
    .error {
      color: var(--danger);
      font-size: 13px;
      padding: 10px 12px;
    }
    .meta {
      padding: 12px;
      font-size: 14px;
      color: var(--muted);
      overflow: auto;
    }
    .meta dt {
      color: var(--text);
      font-weight: 600;
    }
    .meta dd {
      margin: 0 0 6px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0;
    }
    .pill {
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .link {
      color: var(--accent);
      text-decoration: none;
    }
    .link:hover {
      text-decoration: underline;
    }
    .muted { color: var(--muted); }
    .badge-ok { color: var(--ok); }
    .footer-note {
      font-size: 12px;
      color: var(--muted);
      padding: 6px 12px 12px 12px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">ðŸ”© Fasteners STL Viewer â€” GitHub-backed</div>
    <div class="controls" title="Pick kind â†’ family â†’ diameter â†’ length â†’ standard">
      <select id="kindSelect" title="Kind (e.g., Bolts, Nuts, Washers)">
        <option value="" disabled selected>Kindâ€¦</option>
      </select>
      <select id="familySelect" disabled title="Family (e.g., SocketHead, FlatHead, HexHead)">
        <option value="" disabled selected>Familyâ€¦</option>
      </select>
      <select id="diamSelect" disabled title="Diameter (M size)">
        <option value="" disabled selected>Diameterâ€¦</option>
      </select>
      <select id="lenSelect" disabled title="Length (mm)">
        <option value="" disabled selected>Lengthâ€¦</option>
      </select>
      <select id="stdSelect" disabled title="Standard (e.g., ISO4762)">
        <option value="" disabled selected>Standardâ€¦</option>
      </select>
      <button id="resetBtn" title="Reset view">Reset view</button>
    </div>
    <div class="status" id="status">Loading repo indexâ€¦</div>
  </header>

  <main>
    <section class="viewer-card">
      <header>Viewer</header>
      <div id="viewer">
        <canvas id="stage"></canvas>
        <div id="errBox" class="error" style="display:none;"></div>
      </div>
      <div class="footer-note">
        Tip: mouse = rotate, right-drag = pan, wheel = zoom. Model auto-centers on load.
      </div>
    </section>

    <aside class="info-card">
      <header>Metadata</header>
      <div class="meta">
        <dl>
          <dt>Selected file</dt>
          <dd id="selPath" class="muted">â€”</dd>
          <dt>Direct download</dt>
          <dd><a id="dlLink" href="#" class="link" target="_blank" rel="noopener">â€”</a></dd>
          <dt>Counts</dt>
          <dd id="counts" class="muted">â€”</dd>
          <dt>Branch</dt>
          <dd id="branchLbl" class="muted">â€”</dd>
          <dt>Owner/Repo</dt>
          <dd><span id="ownerRepo" class="muted">â€”</span></dd>
        </dl>
        <div class="row">
          <span class="pill" id="probeTotal">Indexed: â€”</span>
          <span class="pill" id="probeKinds">Kinds: â€”</span>
          <span class="pill" id="probeFamilies">Families: â€”</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<!-- Three.js (ES modules) -->
<script type="module">
  // ======== SETTINGS (edit if you fork) ========
  const OWNER = "nimageran";
  const REPO  = "fasteners-viewer";

  // ======== Imports ========
  import * as THREE from "https://unpkg.com/three@0.158.0/build/three.module.js";
  import { OrbitControls } from "https://unpkg.com/three@0.158.0/examples/jsm/controls/OrbitControls.js";
  import { STLLoader } from "https://unpkg.com/three@0.158.0/examples/jsm/loaders/STLLoader.js";

  // ======== DOM ========
  const kindSel = document.getElementById('kindSelect');
  const familySel = document.getElementById('familySelect');
  const diamSel = document.getElementById('diamSelect');
  const lenSel = document.getElementById('lenSelect');
  const stdSel = document.getElementById('stdSelect');
  const status = document.getElementById('status');
  const errBox = document.getElementById('errBox');
  const selPath = document.getElementById('selPath');
  const dlLink = document.getElementById('dlLink');
  const branchLbl = document.getElementById('branchLbl');
  const ownerRepo = document.getElementById('ownerRepo');
  const countsLbl = document.getElementById('counts');
  const probeTotal = document.getElementById('probeTotal');
  const probeKinds = document.getElementById('probeKinds');
  const probeFamilies = document.getElementById('probeFamilies');
  const resetBtn = document.getElementById('resetBtn');

  ownerRepo.textContent = `${OWNER}/${REPO}`;

  // ======== Three.js setup ========
  const canvas = document.getElementById('stage');
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio ?? 1, 2));

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(50, 16/9, 0.1, 2000);

  const hemi = new THREE.HemisphereLight(0xffffff, 0x222244, 0.7);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 1.0);
  dir.position.set(3, 4, 5);
  scene.add(dir);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // Resize handling
  function resizeRenderer() {
    const viewer = document.getElementById('viewer');
    const w = viewer.clientWidth;
    const h = viewer.clientHeight;
    renderer.setSize(w, h, false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }
  window.addEventListener('resize', resizeRenderer);

  let currentMesh = null;

  function clearMesh() {
    if (currentMesh) {
      scene.remove(currentMesh);
      currentMesh.geometry?.dispose?.();
      currentMesh.material?.dispose?.();
      currentMesh = null;
    }
  }

  function fitCameraToObject(mesh) {
    // Compute bounding sphere to frame camera
    mesh.geometry.computeBoundingSphere();
    const bs = mesh.geometry.boundingSphere;
    const r = Math.max(bs.radius, 1e-3);
    const fov = camera.fov * (Math.PI / 180);
    // Distance that fits object height in view
    const dist = r / Math.sin(fov / 2);

    const dirVec = new THREE.Vector3(1, 1, 1).normalize();
    camera.position.copy(bs.center.clone().add(dirVec.multiplyScalar(dist * 1.2)));
    controls.target.copy(bs.center);
    controls.update();
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // ======== Data model ========
  // Entries look like: { kind, family, diam, len, standard, path }
  let entries = [];
  let branch = null;

  // Regex for filename parsing (family can include letters/numbers; standard like ISO4762, DIN912, etc.)
  const fileRx = /^([A-Za-z0-9]+)_M(\d+(?:\.\d+)?)x(\d+(?:\.\d+)?)(?:_([A-Za-z]+[A-Za-z0-9\-]*))?\.stl$/i;

  function parseFilename(name) {
    const m = name.match(fileRx);
    if (!m) return null;
    const [, family, diam, len, standard] = m;
    return {
      family,
      diam: `M${Number(diam)}`, // normalize (e.g., "M3")
      len: String(Number(len)), // remove leading zeros if any
      standard: standard || "â€”"
    };
  }

  function uniqSorted(arr) {
    return [...new Set(arr)].sort((a,b) => {
      // numeric-aware for M sizes and plain numbers
      const numA = parseFloat(String(a).replace(/^M/i,''));
      const numB = parseFloat(String(b).replace(/^M/i,''));
      if (!Number.isNaN(numA) && !Number.isNaN(numB)) return numA - numB;
      return String(a).localeCompare(String(b));
    });
  }

  function populateSelect(sel, values, placeholder) {
    sel.innerHTML = "";
    const opt0 = document.createElement('option');
    opt0.textContent = placeholder;
    opt0.value = "";
    opt0.disabled = true;
    opt0.selected = true;
    sel.appendChild(opt0);
    for (const v of values) {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    }
    sel.disabled = values.length === 0;
  }

  function showError(msg) {
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearError() {
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  async function fetchJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    return r.json();
  }

  async function discoverBranch() {
    // Try to read default_branch; fallback to 'main' then 'master'
    try {
      const repo = await fetchJSON(`https://api.github.com/repos/${OWNER}/${REPO}`);
      branch = repo.default_branch || "main";
    } catch (e) {
      branch = "main";
    }
    // probe 'master' if main fails later
    branchLbl.textContent = branch;
  }

  async function indexRepo() {
    status.textContent = "Indexing STL filesâ€¦";
    await discoverBranch();
    let tree;
    try {
      tree = await fetchJSON(`https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${branch}?recursive=1`);
    } catch (e) {
      // fallback to master
      try {
        branch = "master";
        branchLbl.textContent = branch;
        tree = await fetchJSON(`https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${branch}?recursive=1`);
      } catch (e2) {
        status.textContent = "Failed to load repo tree.";
        showError(e2.message);
        throw e2;
      }
    }
    if (!tree || !tree.tree) {
      status.textContent = "No tree found.";
      return;
    }

    const stlNodes = tree.tree.filter(n => n.type === "blob" && /\.stl$/i.test(n.path));
    const newEntries = [];
    for (const n of stlNodes) {
      const parts = n.path.split('/'); // e.g., ["Bolts","Socket_Head","ISO4762","STL","SocketHead_M10x20_ISO4762.stl"]
      if (parts.length < 2) continue;
      const kind = parts[0]; // "Bolts", "Nuts", ...
      const file = parts[parts.length - 1];
      const parsed = parseFilename(file);
      if (!parsed) continue;

      newEntries.push({
        kind,
        family: parsed.family,
        diam: parsed.diam,
        len: parsed.len,
        standard: parsed.standard,
        path: n.path
      });
    }

    entries = newEntries;
    probeTotal.textContent = `Indexed: ${entries.length}`;
    const kinds = uniqSorted(entries.map(e => e.kind));
    probeKinds.textContent = `Kinds: ${kinds.length}`;
    const families = uniqSorted(entries.map(e => e.family));
    probeFamilies.textContent = `Families: ${families.length}`;

    populateSelect(kindSel, kinds, "Kindâ€¦");
    familySel.disabled = true;
    diamSel.disabled = true;
    lenSel.disabled = true;
    stdSel.disabled = true;
    countsLbl.textContent = "â€”";
    selPath.textContent = "â€”";
    dlLink.textContent = "â€”";
    dlLink.removeAttribute('href');

    status.textContent = `Ready. ${entries.length} STL files indexed.`;
  }

  function updateFamilies() {
    const k = kindSel.value;
    const fams = uniqSorted(entries.filter(e => e.kind === k).map(e => e.family));
    populateSelect(familySel, fams, "Familyâ€¦");
    populateSelect(diamSel, [], "Diameterâ€¦");
    populateSelect(lenSel, [], "Lengthâ€¦");
    populateSelect(stdSel, [], "Standardâ€¦");
    countsLbl.textContent = "â€”";
    clearError();
  }

  function updateDiameters() {
    const k = kindSel.value;
    const f = familySel.value;
    const diams = uniqSorted(entries.filter(e => e.kind === k && e.family === f).map(e => e.diam));
    populateSelect(diamSel, diams, "Diameterâ€¦");
    populateSelect(lenSel, [], "Lengthâ€¦");
    populateSelect(stdSel, [], "Standardâ€¦");
    countsLbl.textContent = "â€”";
    clearError();
  }

  function updateLengths() {
    const k = kindSel.value;
    const f = familySel.value;
    const d = diamSel.value;
    const lens = uniqSorted(entries.filter(e => e.kind === k && e.family === f && e.diam === d).map(e => e.len));
    populateSelect(lenSel, lens, "Lengthâ€¦");
    populateSelect(stdSel, [], "Standardâ€¦");
    countsLbl.textContent = "â€”";
    clearError();
  }

  function updateStandards() {
    const k = kindSel.value;
    const f = familySel.value;
    const d = diamSel.value;
    const l = lenSel.value;
    const stds = uniqSorted(entries.filter(e => e.kind === k && e.family === f && e.diam === d && e.len === l).map(e => e.standard));
    populateSelect(stdSel, stds, "Standardâ€¦");
    clearError();
  }

  async function loadSelection() {
    const k = kindSel.value;
    const f = familySel.value;
    const d = diamSel.value;
    const l = lenSel.value;
    const s = stdSel.value;

    const match = entries.find(e => e.kind === k && e.family === f && e.diam === d && e.len === l && e.standard === s);
    if (!match) {
      showError("No STL matched this combination. Check filenames.");
      return;
    }
    const rawUrl = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${branch}/${match.path}`;

    selPath.textContent = match.path;
    dlLink.textContent = "Download STL";
    dlLink.href = rawUrl;

    clearError();
    status.textContent = "Loading STLâ€¦";
    try {
      clearMesh();
      const loader = new STLLoader();
      loader.load(rawUrl, (geom) => {
        // Ensure normals exist
        geom.computeVertexNormals();

        // Center geometry at origin (so framing is stable)
        geom.computeBoundingBox();
        const bb = geom.boundingBox;
        const center = new THREE.Vector3();
        bb.getCenter(center);
        geom.translate(-center.x, -center.y, -center.z);

        // Create mesh
        const mat = new THREE.MeshPhysicalMaterial({
          color: 0xb0c4de,
          roughness: 0.5,
          metalness: 0.6
        });
        currentMesh = new THREE.Mesh(geom, mat);
        scene.add(currentMesh);

        // Frame it
        fitCameraToObject(currentMesh);
        resizeRenderer();
        status.textContent = "Loaded.";
      }, (xhr) => {
        // progress
        if (xhr.total) {
          const pct = ((xhr.loaded / xhr.total) * 100).toFixed(1);
          status.textContent = `Loading STLâ€¦ ${pct}%`;
        }
      }, (err) => {
        showError(`STL load failed: ${err?.message || err}`);
        status.textContent = "Load failed.";
      });
    } catch (e) {
      showError(`STL load exception: ${e.message}`);
      status.textContent = "Load failed.";
    }
  }

  // Wire up
  kindSel.addEventListener('change', updateFamilies);
  familySel.addEventListener('change', updateDiameters);
  diamSel.addEventListener('change', updateLengths);
  lenSel.addEventListener('change', updateStandards);
  stdSel.addEventListener('change', loadSelection);
  resetBtn.addEventListener('click', () => {
    if (currentMesh) fitCameraToObject(currentMesh);
  });

  // Kick off
  resizeRenderer();
  indexRepo();
</script>
=======
  <title>Fasteners Viewer â€” Auto from STL Names</title>
  <style>
    :root {
      --bg:#0f1220; --panel:#181c2f; --accent:#7bd389; --muted:#9aa4b2; --text:#e7ecf3; --err:#ff7b7b;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text)}
    header{padding:16px 20px; background:linear-gradient(90deg,#14182a,#1c2240); border-bottom:1px solid #232a44}
    header h1{margin:0; font-size:18px; letter-spacing:0.3px}
    header small{display:block; color:var(--muted)}
    main{display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px; min-height:calc(100vh - 64px)}
    @media (max-width:960px){main{grid-template-columns:1fr}}
    .card{background:var(--panel); border:1px solid #232a44; border-radius:14px; padding:14px}
    .row{display:flex; gap:8px; align-items:center}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    select,button,input[type="text"]{
      width:100%; padding:10px 12px; background:#0e1326; color:var(--text);
      border:1px solid #2a3153; border-radius:10px; outline:none;
    }
    select:disabled{opacity:0.6; cursor:not-allowed}
    button{cursor:pointer; background:#0d1731}
    button:hover{border-color:#3a4370}
    .status{font-size:12px; color:var(--muted); margin-top:8px; white-space:pre-wrap}
    .status .error{color:var(--err)}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; background:#0e1633; border:1px solid #27305b; color:#b6c0d4; font-size:12px}
    .viewer{position:relative; height:calc(100vh - 120px); min-height:420px; background:#0b0e1c; border:1px solid #232a44; border-radius:14px; overflow:hidden}
    .viewer canvas{display:block; width:100%; height:100%}
    .toolbar{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:8px}
    a.dl{color:var(--accent); text-decoration:none}
    a.dl:hover{text-decoration:underline}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .kvs{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
    .kvs span{border:1px solid #2a3153; background:#0f1633; padding:4px 8px; border-radius:999px; font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Fasteners Viewer <span class="pill">autoâ€‘indexed from STL filenames</span></h1>
    <small>Repo: <span id="repoLabel"></span> â€¢ Branch: <span id="branchLabel"></span></small>
  </header>
  <main>
    <section class="card">
      <div class="grid">
        <div>
          <label for="familySel">Head / Family</label>
          <select id="familySel" disabled></select>
        </div>
        <div>
          <label for="diamSel">Diameter (from name)</label>
          <select id="diamSel" disabled></select>
        </div>
      </div>
      <div class="grid">
        <div>
          <label for="lenSel">Length (from name)</label>
          <select id="lenSel" disabled></select>
        </div>
        <div>
          <label>Standard</label>
          <div id="stdBox" class="kvs"></div>
        </div>
      </div>
      <div class="toolbar">
        <div class="row">
          <button id="reloadBtn" title="Re-scan repository">Reload</button>
        </div>
        <div class="row">
          <a id="dlLink" class="dl" href="#" target="_blank" rel="noopener">Download STL</a>
        </div>
      </div>
      <div class="status" id="status">Loading repo indexâ€¦</div>
    </section>
    <section class="card">
      <div class="viewer" id="viewer"></div>
    </section>
  </main>

  <!-- Three.js + loaders -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/examples/js/loaders/STLLoader.js"></script>

  <script>
  (function(){
    const owner = "nimageran";
    const repo = "fasteners-viewer";
    const rootDir = "Bolts";
    const repoApi = `https://api.github.com/repos/${owner}/${repo}`;
    const contentsApi = (path, ref) => `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(ref)}`;
    let defaultBranch = "main"; // will be probed
    const state = {
      files: [], // {path, name, family, diam, len, std, rawUrl}
      byFamily: new Map(),
      selected: {family:null, diam:null, len:null, std:null, file:null}
    };

    const el = {
      repoLabel: document.getElementById('repoLabel'),
      branchLabel: document.getElementById('branchLabel'),
      familySel: document.getElementById('familySel'),
      diamSel: document.getElementById('diamSel'),
      lenSel: document.getElementById('lenSel'),
      stdBox: document.getElementById('stdBox'),
      status: document.getElementById('status'),
      reloadBtn: document.getElementById('reloadBtn'),
      dlLink: document.getElementById('dlLink'),
      viewer: document.getElementById('viewer'),
    };

    el.repoLabel.textContent = `${owner}/${repo}`;

    // --- UI helpers
    function setStatus(msg, isErr=false){ el.status.innerHTML = isErr ? `<span class="error">${msg}</span>` : msg; }
    function clearSelect(s){ s.innerHTML=""; }
    function fillSelect(s, opts, placeholder){
      clearSelect(s);
      const p = document.createElement('option');
      p.value=""; p.textContent = placeholder; p.disabled = true; p.selected = true;
      s.appendChild(p);
      opts.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; s.appendChild(o); });
      s.disabled = false;
    }
    function uniqSorted(arr){ return [...new Set(arr)].sort((a,b)=>{
      const na = parseFloat(a.replace(/^M/,"")), nb = parseFloat(b.replace(/^M/,""));
      if(!isNaN(na) && !isNaN(nb)) return na-nb;
      return String(a).localeCompare(String(b));
    }); }
    function lengthsSorted(arr){ return [...new Set(arr)].sort((a,b)=>Number(a)-Number(b)); }

    // --- Filename parser
    // Examples: SocketHead_M10x25_ISO4762.stl  |  FlatHead_M3x16_ISO10642.stl
    const NAME_RE = /^(?<family>[A-Za-z]+Head)_(?<diam>M\d+(?:\.\d+)?)x(?<len>\d+(?:\.\d+)?)_(?<std>ISO\d+)\.stl$/i;

    // --- GitHub traversal to collect all STL files under Bolts/**/STL
    async function getJson(url){
      const r = await fetch(url, {headers: {'Accept': 'application/vnd.github+json'}});
      if(!r.ok){
        const t = await r.text();
        throw new Error(`HTTP ${r.status} on ${url}\n${t.slice(0,400)}`);
      }
      return r.json();
    }

    async function detectBranch(){
      try{
        const info = await getJson(repoApi);
        defaultBranch = info.default_branch || defaultBranch;
        el.branchLabel.textContent = defaultBranch;
      }catch(e){
        setStatus(`Could not read repo metadata. Using '${defaultBranch}' branch.\n` + e.message, true);
        el.branchLabel.textContent = defaultBranch;
      }
    }

    async function listDir(path){
      const data = await getJson(contentsApi(path, defaultBranch));
      return Array.isArray(data) ? data : [];
    }

    async function walkForStl(start){
      // Depth-first down to */STL directories
      const items = await listDir(start);
      for(const it of items){
        if(it.type === "dir"){
          if(it.name.toLowerCase() === "stl"){
            const stls = await listDir(it.path);
            for(const f of stls){
              if(f.type === "file" && f.name.toLowerCase().endsWith(".stl")){
                const m = f.name.match(NAME_RE);
                if(!m) continue; // skip unparseable names
                const family = m.groups.family; // SocketHead / FlatHead / etc.
                const diam = m.groups.diam.toUpperCase(); // M3..M24
                const len = m.groups.len; // string numeric
                const std = m.groups.std.toUpperCase();
                const rawUrl = `https://raw.githubusercontent.com/${owner}/${repo}/${defaultBranch}/${f.path}`;
                const entry = {path:f.path, name:f.name, family, diam, len, std, rawUrl};
                state.files.push(entry);
              }
            }
          }else{
            await walkForStl(it.path);
          }
        }
      }
    }

    function indexFiles(){
      state.byFamily.clear();
      for(const f of state.files){
        if(!state.byFamily.has(f.family)) state.byFamily.set(f.family, new Map());
        const byDiam = state.byFamily.get(f.family);
        if(!byDiam.has(f.diam)) byDiam.set(f.diam, []);
        byDiam.get(f.diam).push(f);
      }
    }

    function populateFamilies(){
      const fams = uniqSorted([...state.byFamily.keys()]);
      fillSelect(el.familySel, fams, "Select family from names");
    }

    function populateDiameters(family){
      const byDiam = state.byFamily.get(family) || new Map();
      const diams = uniqSorted([...byDiam.keys()]);
      fillSelect(el.diamSel, diams, "Select diameter (Mâ€¦)");
      clearSelect(el.lenSel); el.lenSel.disabled = true;
      el.stdBox.innerHTML = "";
    }

    function populateLengths(family, diam){
      const byDiam = state.byFamily.get(family) || new Map();
      const entries = (byDiam.get(diam) || []);
      const lens = lengthsSorted(entries.map(e=>e.len));
      fillSelect(el.lenSel, lens, "Select length (mm)");
      // standards present for this subset
      const stds = [...new Set(entries.map(e=>e.std))].sort();
      el.stdBox.innerHTML = stds.map(s=>`<span>${s}</span>`).join("");
    }

    function selectFile(){
      const fam = el.familySel.value;
      const d = el.diamSel.value;
      const L = el.lenSel.value;
      if(!fam || !d || !L) return;
      const list = (state.byFamily.get(fam)?.get(d)) || [];
      const file = list.find(x => x.len === L);
      if(!file){
        setStatus(`No STL found for ${fam} ${d} x ${L}`, true);
        return;
      }
      state.selected = {family:fam, diam:d, len:L, std:file.std, file};
      setStatus(`Loaded from filename â†’ family=${fam}, diam=${d}, length=${L}, std=${file.std}\n${file.name}`);
      el.dlLink.href = file.rawUrl;
      loadStl(file.rawUrl);
    }

    // --- 3D viewer
    let renderer, scene, camera, controls, loader;
    function init3D(){
      const W = el.viewer.clientWidth;
      const H = el.viewer.clientHeight;
      renderer = new THREE.WebGLRenderer({antialias:true});
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(W,H);
      el.viewer.innerHTML = "";
      el.viewer.appendChild(renderer.domElement);

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b0e1c);
      camera = new THREE.PerspectiveCamera(45, W/H, 0.1, 2000);
      camera.position.set(180,140,180);
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      const hemi = new THREE.HemisphereLight(0xffffff, 0x223344, 0.8);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 1.0);
      dir.position.set(200,200,200);
      scene.add(dir);

      const grid = new THREE.GridHelper(400, 20, 0x23304f, 0x161c31);
      grid.material.opacity = 0.3; grid.material.transparent = true;
      scene.add(grid);

      loader = new THREE.STLLoader();
      window.addEventListener('resize', ()=>{
        const w = el.viewer.clientWidth, h = el.viewer.clientHeight;
        camera.aspect = w/h; camera.updateProjectionMatrix();
        renderer.setSize(w,h);
      });

      animate();
    }
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    let mesh=null;
    function loadStl(url){
      setStatus(`Loading STLâ€¦\n${url}`);
      loader.load(url, (geom)=>{
        if(mesh) { scene.remove(mesh); mesh.geometry.dispose(); mesh.material.dispose(); mesh=null; }
        geom.computeBoundingBox();
        const bbox = geom.boundingBox;
        const size = new THREE.Vector3(); bbox.getSize(size);
        const center = new THREE.Vector3(); bbox.getCenter(center);
        geom.translate(-center.x, -center.y, -center.z);

        const mat = new THREE.MeshStandardMaterial({metalness:0.8, roughness:0.35, color:0xb8c2d8});
        mesh = new THREE.Mesh(geom, mat);
        scene.add(mesh);

        // frame
        const maxDim = Math.max(size.x, size.y, size.z);
        const dist = maxDim * 2.2 + 40;
        camera.position.set(dist, dist*0.7, dist);
        controls.target.set(0,0,0); controls.update();

        setStatus(`STL loaded âœ“  sizeâ‰ˆ ${size.x.toFixed(1)}Ã—${size.y.toFixed(1)}Ã—${size.z.toFixed(1)} mm`);
      }, (xhr)=>{
        // progress
      }, (err)=>{
        setStatus(`Failed to load STL\n${err?.message || err}`, true);
      });
    }

    // --- Wiring
    el.reloadBtn.addEventListener('click', bootstrap);
    el.familySel.addEventListener('change', ()=>{
      if(!el.familySel.value) return;
      populateDiameters(el.familySel.value);
    });
    el.diamSel.addEventListener('change', ()=>{
      if(!el.familySel.value || !el.diamSel.value) return;
      populateLengths(el.familySel.value, el.diamSel.value);
    });
    el.lenSel.addEventListener('change', selectFile);

    async function bootstrap(){
      // lock UI during load
      [el.familySel, el.diamSel, el.lenSel].forEach(s=>{ s.disabled = true; });
      el.stdBox.innerHTML = "";
      setStatus("Loading repo indexâ€¦");
      try{
        await detectBranch();
        // reset
        state.files.length = 0;
        state.byFamily.clear();
        await walkForStl(rootDir);
        if(state.files.length === 0){
          setStatus("No STL files found under Bolts/**/STL or names not matching pattern.\nExpected: <Family>_M<diam>x<len>_<ISO>.stl", true);
          return;
        }
        indexFiles();
        populateFamilies();
        setStatus(`Indexed ${state.files.length} STL files from filenames.\nChoose family â†’ diameter â†’ length.`);
      }catch(e){
        setStatus("Indexing failed:\n"+e.message, true);
      }
    }

    init3D();
    bootstrap();
  })();
  </script>
>>>>>>> bb41b64153fb71c39674690760d0e6487f9a58af
</body>
</html>
