<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fasteners STL Viewer â€” GitHub-backed</title>
  <style>
    :root {
      --bg: #0f1115;
      --card: #151823;
      --text: #e7ecf1;
      --muted: #9aa4b2;
      --accent: #6aa6ff;
      --danger: #ff6a6a;
      --ok: #66d19e;
      --border: #23283a;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100%;
    }
    header {
      border-bottom: 1px solid var(--border);
      padding: 10px 14px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      background: #0e1220;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .title {
      font-weight: 700;
      letter-spacing: .2px;
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(5, minmax(120px, 1fr)) auto;
      gap: 8px;
      width: 100%;
    }
    select, button, input[type="text"] {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
    }
    select:focus, button:focus, input[type="text"]:focus {
      outline: 2px solid var(--accent);
      outline-offset: 1px;
    }
    button {
      cursor: pointer;
      white-space: nowrap;
    }
    .status {
      font-size: 13px;
      color: var(--muted);
      margin-left: 8px;
    }
    main {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 14px;
      padding: 14px;
      height: calc(100vh - 58px);
      box-sizing: border-box;
    }
    .viewer-card, .info-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: grid;
      grid-template-rows: auto 1fr;
      min-height: 0;
    }
    .viewer-card header, .info-card header {
      background: #0f1424;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      letter-spacing: .2px;
    }
    #viewer {
      position: relative;
      min-height: 0;
    }
    #stage {
      width: 100%;
      height: 100%;
      display: block;
      background: linear-gradient(180deg, #0f1115 0%, #0f1115 60%, #0b0d12 100%);
    }
    .error {
      color: var(--danger);
      font-size: 13px;
      padding: 10px 12px;
    }
    .meta {
      padding: 12px;
      font-size: 14px;
      color: var(--muted);
      overflow: auto;
    }
    .meta dt {
      color: var(--text);
      font-weight: 600;
    }
    .meta dd {
      margin: 0 0 6px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin: 8px 0;
    }
    .pill {
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .link {
      color: var(--accent);
      text-decoration: none;
    }
    .link:hover {
      text-decoration: underline;
    }
    .muted { color: var(--muted); }
    .badge-ok { color: var(--ok); }
    .footer-note {
      font-size: 12px;
      color: var(--muted);
      padding: 6px 12px 12px 12px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">ðŸ”© Fasteners STL Viewer â€” GitHub-backed</div>
    <div class="controls" title="Pick kind â†’ family â†’ diameter â†’ length â†’ standard">
      <select id="kindSelect" title="Kind (e.g., Bolts, Nuts, Washers)">
        <option value="" disabled selected>Kindâ€¦</option>
      </select>
      <select id="familySelect" disabled title="Family (e.g., SocketHead, FlatHead, HexHead)">
        <option value="" disabled selected>Familyâ€¦</option>
      </select>
      <select id="diamSelect" disabled title="Diameter (M size)">
        <option value="" disabled selected>Diameterâ€¦</option>
      </select>
      <select id="lenSelect" disabled title="Length (mm)">
        <option value="" disabled selected>Lengthâ€¦</option>
      </select>
      <select id="stdSelect" disabled title="Standard (e.g., ISO4762)">
        <option value="" disabled selected>Standardâ€¦</option>
      </select>
      <button id="resetBtn" title="Reset view">Reset view</button>
    </div>
    <div class="status" id="status">Loading repo indexâ€¦</div>
  </header>

  <main>
    <section class="viewer-card">
      <header>Viewer</header>
      <div id="viewer">
        <canvas id="stage"></canvas>
        <div id="errBox" class="error" style="display:none;"></div>
      </div>
      <div class="footer-note">
        Tip: mouse = rotate, right-drag = pan, wheel = zoom. Model auto-centers on load.
      </div>
    </section>

    <aside class="info-card">
      <header>Metadata</header>
      <div class="meta">
        <dl>
          <dt>Selected file</dt>
          <dd id="selPath" class="muted">â€”</dd>
          <dt>Direct download</dt>
          <dd><a id="dlLink" href="#" class="link" target="_blank" rel="noopener">â€”</a></dd>
          <dt>Counts</dt>
          <dd id="counts" class="muted">â€”</dd>
          <dt>Branch</dt>
          <dd id="branchLbl" class="muted">â€”</dd>
          <dt>Owner/Repo</dt>
          <dd><span id="ownerRepo" class="muted">â€”</span></dd>
        </dl>
        <div class="row">
          <span class="pill" id="probeTotal">Indexed: â€”</span>
          <span class="pill" id="probeKinds">Kinds: â€”</span>
          <span class="pill" id="probeFamilies">Families: â€”</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<!-- Three.js (ES modules) -->
<script type="module">
  // ======== SETTINGS (edit if you fork) ========
  const OWNER = "nimageran";
  const REPO  = "fasteners-viewer";

  // ======== Imports ========
  import * as THREE from "https://unpkg.com/three@0.158.0/build/three.module.js";
  import { OrbitControls } from "https://unpkg.com/three@0.158.0/examples/jsm/controls/OrbitControls.js";
  import { STLLoader } from "https://unpkg.com/three@0.158.0/examples/jsm/loaders/STLLoader.js";

  // ======== DOM ========
  const kindSel = document.getElementById('kindSelect');
  const familySel = document.getElementById('familySelect');
  const diamSel = document.getElementById('diamSelect');
  const lenSel = document.getElementById('lenSelect');
  const stdSel = document.getElementById('stdSelect');
  const status = document.getElementById('status');
  const errBox = document.getElementById('errBox');
  const selPath = document.getElementById('selPath');
  const dlLink = document.getElementById('dlLink');
  const branchLbl = document.getElementById('branchLbl');
  const ownerRepo = document.getElementById('ownerRepo');
  const countsLbl = document.getElementById('counts');
  const probeTotal = document.getElementById('probeTotal');
  const probeKinds = document.getElementById('probeKinds');
  const probeFamilies = document.getElementById('probeFamilies');
  const resetBtn = document.getElementById('resetBtn');

  ownerRepo.textContent = `${OWNER}/${REPO}`;

  // ======== Three.js setup ========
  const canvas = document.getElementById('stage');
  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio ?? 1, 2));

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(50, 16/9, 0.1, 2000);

  const hemi = new THREE.HemisphereLight(0xffffff, 0x222244, 0.7);
  scene.add(hemi);
  const dir = new THREE.DirectionalLight(0xffffff, 1.0);
  dir.position.set(3, 4, 5);
  scene.add(dir);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // Resize handling
  function resizeRenderer() {
    const viewer = document.getElementById('viewer');
    const w = viewer.clientWidth;
    const h = viewer.clientHeight;
    renderer.setSize(w, h, false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }
  window.addEventListener('resize', resizeRenderer);

  let currentMesh = null;

  function clearMesh() {
    if (currentMesh) {
      scene.remove(currentMesh);
      currentMesh.geometry?.dispose?.();
      currentMesh.material?.dispose?.();
      currentMesh = null;
    }
  }

  function fitCameraToObject(mesh) {
    // Compute bounding sphere to frame camera
    mesh.geometry.computeBoundingSphere();
    const bs = mesh.geometry.boundingSphere;
    const r = Math.max(bs.radius, 1e-3);
    const fov = camera.fov * (Math.PI / 180);
    // Distance that fits object height in view
    const dist = r / Math.sin(fov / 2);

    const dirVec = new THREE.Vector3(1, 1, 1).normalize();
    camera.position.copy(bs.center.clone().add(dirVec.multiplyScalar(dist * 1.2)));
    controls.target.copy(bs.center);
    controls.update();
  }

  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // ======== Data model ========
  // Entries look like: { kind, family, diam, len, standard, path }
  let entries = [];
  let branch = null;

  // Regex for filename parsing (family can include letters/numbers; standard like ISO4762, DIN912, etc.)
  const fileRx = /^([A-Za-z0-9]+)_M(\d+(?:\.\d+)?)x(\d+(?:\.\d+)?)(?:_([A-Za-z]+[A-Za-z0-9\-]*))?\.stl$/i;

  function parseFilename(name) {
    const m = name.match(fileRx);
    if (!m) return null;
    const [, family, diam, len, standard] = m;
    return {
      family,
      diam: `M${Number(diam)}`, // normalize (e.g., "M3")
      len: String(Number(len)), // remove leading zeros if any
      standard: standard || "â€”"
    };
  }

  function uniqSorted(arr) {
    return [...new Set(arr)].sort((a,b) => {
      // numeric-aware for M sizes and plain numbers
      const numA = parseFloat(String(a).replace(/^M/i,''));
      const numB = parseFloat(String(b).replace(/^M/i,''));
      if (!Number.isNaN(numA) && !Number.isNaN(numB)) return numA - numB;
      return String(a).localeCompare(String(b));
    });
  }

  function populateSelect(sel, values, placeholder) {
    sel.innerHTML = "";
    const opt0 = document.createElement('option');
    opt0.textContent = placeholder;
    opt0.value = "";
    opt0.disabled = true;
    opt0.selected = true;
    sel.appendChild(opt0);
    for (const v of values) {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    }
    sel.disabled = values.length === 0;
  }

  function showError(msg) {
    errBox.style.display = "block";
    errBox.textContent = msg;
  }
  function clearError() {
    errBox.style.display = "none";
    errBox.textContent = "";
  }

  async function fetchJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    return r.json();
  }

  async function discoverBranch() {
    // Try to read default_branch; fallback to 'main' then 'master'
    try {
      const repo = await fetchJSON(`https://api.github.com/repos/${OWNER}/${REPO}`);
      branch = repo.default_branch || "main";
    } catch (e) {
      branch = "main";
    }
    // probe 'master' if main fails later
    branchLbl.textContent = branch;
  }

  async function indexRepo() {
    status.textContent = "Indexing STL filesâ€¦";
    await discoverBranch();
    let tree;
    try {
      tree = await fetchJSON(`https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${branch}?recursive=1`);
    } catch (e) {
      // fallback to master
      try {
        branch = "master";
        branchLbl.textContent = branch;
        tree = await fetchJSON(`https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${branch}?recursive=1`);
      } catch (e2) {
        status.textContent = "Failed to load repo tree.";
        showError(e2.message);
        throw e2;
      }
    }
    if (!tree || !tree.tree) {
      status.textContent = "No tree found.";
      return;
    }

    const stlNodes = tree.tree.filter(n => n.type === "blob" && /\.stl$/i.test(n.path));
    const newEntries = [];
    for (const n of stlNodes) {
      const parts = n.path.split('/'); // e.g., ["Bolts","Socket_Head","ISO4762","STL","SocketHead_M10x20_ISO4762.stl"]
      if (parts.length < 2) continue;
      const kind = parts[0]; // "Bolts", "Nuts", ...
      const file = parts[parts.length - 1];
      const parsed = parseFilename(file);
      if (!parsed) continue;

      newEntries.push({
        kind,
        family: parsed.family,
        diam: parsed.diam,
        len: parsed.len,
        standard: parsed.standard,
        path: n.path
      });
    }

    entries = newEntries;
    probeTotal.textContent = `Indexed: ${entries.length}`;
    const kinds = uniqSorted(entries.map(e => e.kind));
    probeKinds.textContent = `Kinds: ${kinds.length}`;
    const families = uniqSorted(entries.map(e => e.family));
    probeFamilies.textContent = `Families: ${families.length}`;

    populateSelect(kindSel, kinds, "Kindâ€¦");
    familySel.disabled = true;
    diamSel.disabled = true;
    lenSel.disabled = true;
    stdSel.disabled = true;
    countsLbl.textContent = "â€”";
    selPath.textContent = "â€”";
    dlLink.textContent = "â€”";
    dlLink.removeAttribute('href');

    status.textContent = `Ready. ${entries.length} STL files indexed.`;
  }

  function updateFamilies() {
    const k = kindSel.value;
    const fams = uniqSorted(entries.filter(e => e.kind === k).map(e => e.family));
    populateSelect(familySel, fams, "Familyâ€¦");
    populateSelect(diamSel, [], "Diameterâ€¦");
    populateSelect(lenSel, [], "Lengthâ€¦");
    populateSelect(stdSel, [], "Standardâ€¦");
    countsLbl.textContent = "â€”";
    clearError();
  }

  function updateDiameters() {
    const k = kindSel.value;
    const f = familySel.value;
    const diams = uniqSorted(entries.filter(e => e.kind === k && e.family === f).map(e => e.diam));
    populateSelect(diamSel, diams, "Diameterâ€¦");
    populateSelect(lenSel, [], "Lengthâ€¦");
    populateSelect(stdSel, [], "Standardâ€¦");
    countsLbl.textContent = "â€”";
    clearError();
  }

  function updateLengths() {
    const k = kindSel.value;
    const f = familySel.value;
    const d = diamSel.value;
    const lens = uniqSorted(entries.filter(e => e.kind === k && e.family === f && e.diam === d).map(e => e.len));
    populateSelect(lenSel, lens, "Lengthâ€¦");
    populateSelect(stdSel, [], "Standardâ€¦");
    countsLbl.textContent = "â€”";
    clearError();
  }

  function updateStandards() {
    const k = kindSel.value;
    const f = familySel.value;
    const d = diamSel.value;
    const l = lenSel.value;
    const stds = uniqSorted(entries.filter(e => e.kind === k && e.family === f && e.diam === d && e.len === l).map(e => e.standard));
    populateSelect(stdSel, stds, "Standardâ€¦");
    clearError();
  }

  async function loadSelection() {
    const k = kindSel.value;
    const f = familySel.value;
    const d = diamSel.value;
    const l = lenSel.value;
    const s = stdSel.value;

    const match = entries.find(e => e.kind === k && e.family === f && e.diam === d && e.len === l && e.standard === s);
    if (!match) {
      showError("No STL matched this combination. Check filenames.");
      return;
    }
    const rawUrl = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${branch}/${match.path}`;

    selPath.textContent = match.path;
    dlLink.textContent = "Download STL";
    dlLink.href = rawUrl;

    clearError();
    status.textContent = "Loading STLâ€¦";
    try {
      clearMesh();
      const loader = new STLLoader();
      loader.load(rawUrl, (geom) => {
        // Ensure normals exist
        geom.computeVertexNormals();

        // Center geometry at origin (so framing is stable)
        geom.computeBoundingBox();
        const bb = geom.boundingBox;
        const center = new THREE.Vector3();
        bb.getCenter(center);
        geom.translate(-center.x, -center.y, -center.z);

        // Create mesh
        const mat = new THREE.MeshPhysicalMaterial({
          color: 0xb0c4de,
          roughness: 0.5,
          metalness: 0.6
        });
        currentMesh = new THREE.Mesh(geom, mat);
        scene.add(currentMesh);

        // Frame it
        fitCameraToObject(currentMesh);
        resizeRenderer();
        status.textContent = "Loaded.";
      }, (xhr) => {
        // progress
        if (xhr.total) {
          const pct = ((xhr.loaded / xhr.total) * 100).toFixed(1);
          status.textContent = `Loading STLâ€¦ ${pct}%`;
        }
      }, (err) => {
        showError(`STL load failed: ${err?.message || err}`);
        status.textContent = "Load failed.";
      });
    } catch (e) {
      showError(`STL load exception: ${e.message}`);
      status.textContent = "Load failed.";
    }
  }

  // Wire up
  kindSel.addEventListener('change', updateFamilies);
  familySel.addEventListener('change', updateDiameters);
  diamSel.addEventListener('change', updateLengths);
  lenSel.addEventListener('change', updateStandards);
  stdSel.addEventListener('change', loadSelection);
  resetBtn.addEventListener('click', () => {
    if (currentMesh) fitCameraToObject(currentMesh);
  });

  // Kick off
  resizeRenderer();
  indexRepo();
</script>
</body>
</html>
