<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Fasteners Viewer — Auto Index</title>
<style>
  :root { --bg:#0e0f12; --fg:#e9eef3; --muted:#95a3b3; --accent:#6eb1ff; --panel:#171a21; --ok:#42d392; --bad:#ff6b6b; }
  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--fg); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  header { padding:14px 16px; border-bottom:1px solid #222630; background:var(--panel); position:sticky; top:0; z-index:50; }
  header h1 { margin:0; font-size:18px; letter-spacing:.3px; }
  main { display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px; height:calc(100% - 56px); }
  @media (max-width: 900px) { main { grid-template-columns: 1fr; grid-auto-rows:min-content 1fr; } }
  .card { background:var(--panel); border:1px solid #1f2430; border-radius:14px; padding:14px; }
  .controls { display:flex; flex-direction:column; gap:10px; position:relative; z-index:10; }
  label { font-size:12px; color:var(--muted); margin-bottom:6px; display:block; }
  select, button, input[type="text"] {
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3140; background:#12151b; color:var(--fg);
    outline:none; appearance:auto;
  }
  select:disabled { opacity:.6; cursor:not-allowed; }
  button { cursor:pointer; background:#111720; border:1px solid #2a3140; }
  button:hover { border-color:#3a4458; }
  .row { display:grid; grid-template-columns:1fr; gap:8px; }
  .status { font-size:12px; color:var(--muted); white-space:pre-wrap; background:#0d1016; border:1px dashed #2a3140; border-radius:10px; padding:10px; }
  .status.ok { color:var(--ok); border-color:#264a38; }
  .status.bad { color:var(--bad); border-color:#4a2630; }
  .viewer { height: calc(100vh - 112px); min-height:360px; border-radius:14px; overflow:hidden; position:relative; }
  #three { position:absolute; inset:0; }
  .legend { font-size:13px; color:var(--muted); margin-top:6px;}
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#10151d; border:1px solid #2a3140; margin-right:6px; }
  .footer { font-size:12px; color:var(--muted); padding-top:8px; }
  .link { color:var(--accent); text-decoration:none; }
  .link:hover { text-decoration:underline; }
</style>
</head>
<body>
  <header>
    <h1>Fasteners Viewer — Auto Index from GitHub</h1>
  </header>

  <main>
    <section class="card">
      <div class="controls">
        <div class="row">
          <label for="repoOwner">GitHub owner</label>
          <input id="repoOwner" type="text" value="nimageran" />
        </div>
        <div class="row">
          <label for="repoName">Repository</label>
          <input id="repoName" type="text" value="fasteners-viewer" />
        </div>
        <div class="row">
          <button id="btnReload">Load / Reload Repo Index</button>
          <div id="status" class="status">Loading repo index…</div>
        </div>
        <hr style="border:none;border-top:1px solid #2a3140;margin:6px 0 10px 0;">
        <div class="row">
          <label for="familySel">Family</label>
          <select id="familySel" disabled></select>
        </div>
        <div class="row">
          <label for="diamSel">Diameter</label>
          <select id="diamSel" disabled></select>
        </div>
        <div class="row">
          <label for="lenSel">Length</label>
          <select id="lenSel" disabled></select>
        </div>
        <div class="legend">
          <span class="pill" id="pillCount">0 files</span>
          <span class="pill" id="pillBranch">branch: ?</span>
        </div>
        <div class="footer">
          Parsed from file names like <code>SocketHead_M10x25_ISO4762.stl</code> and <code>FlatHead_M3x16_ISO10642.stl</code>.
          If you add files to <code>Bolts/**/STL</code>, press Reload.
        </div>
      </div>
    </section>

    <section class="card">
      <div class="viewer">
        <div id="three"></div>
      </div>
      <div class="legend">
        <span class="pill" id="pillFamily">—</span>
        <span class="pill" id="pillDia">—</span>
        <span class="pill" id="pillLen">—</span>
        <a id="rawLink" class="link" href="#" target="_blank" rel="noopener">Open raw STL</a>
      </div>
    </section>
  </main>

<script type="module">
// === Utility ===
const $ = sel => document.querySelector(sel);
const statusEl = $('#status');
const familySel = $('#familySel');
const diamSel = $('#diamSel');
const lenSel  = $('#lenSel');
const pillCount = $('#pillCount');
const pillBranch = $('#pillBranch');
const pillFamily = $('#pillFamily');
const pillDia = $('#pillDia');
const pillLen = $('#pillLen');
const rawLink = $('#rawLink');

function setStatus(text, cls='') {
  statusEl.className = 'status ' + cls;
  statusEl.textContent = text;
}
function byNum(a,b){ return a-b; }

// Regex for names: Family_M##xL_ISO####.stl   (Family examples: SocketHead, FlatHead, HexHead)
const NAME_RE = /^([A-Za-z]+Head)_?(M\d+)x(\d+)_ISO(\d+)\.stl$/i;

// Data cache
let treeFiles = [];
let indexMap = new Map(); // family -> Map(diameter -> Set(lengths))
let pathMap = new Map();  // family|diam|len -> path
let branch = '?';

function clearSelect(sel, placeholder='—') {
  sel.innerHTML = '';
  const opt = document.createElement('option');
  opt.value = '';
  opt.textContent = placeholder;
  sel.appendChild(opt);
  sel.disabled = true;
}

function populateSelect(sel, values) {
  clearSelect(sel, 'Select…');
  for (const v of values) {
    const o = document.createElement('option');
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  }
  sel.disabled = values.length === 0;
}

async function fetchJson(url) {
  const res = await fetch(url, { headers: { 'Accept': 'application/vnd.github+json' } });
  if (!res.ok) throw new Error(`${res.status} ${res.statusText} for ${url}`);
  return res.json();
}

// Load tree, build index
async function loadIndex(owner, repo) {
  setStatus('Loading repo index…');
  clearSelect(familySel); clearSelect(diamSel); clearSelect(lenSel);
  indexMap.clear(); pathMap.clear();
  branch = '?';

  const repoInfoUrl = `https://api.github.com/repos/${owner}/${repo}`;
  const repoInfo = await fetchJson(repoInfoUrl);
  branch = repoInfo.default_branch || 'main';
  pillBranch.textContent = `branch: ${branch}`;

  // Get full tree
  const treeUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${encodeURIComponent(branch)}?recursive=1`;
  const tree = await fetchJson(treeUrl);
  if (!tree.tree) throw new Error('No tree data.');

  // Filter .stl in Bolts/**/STL
  treeFiles = tree.tree
    .filter(x => x.type === 'blob' && /\.stl$/i.test(x.path) && /^(?:[^/]+\/)*Bolts\/.*\/STL\//i.test(x.path));

  if (treeFiles.length === 0) {
    setStatus('No STL files were found under Bolts/**/STL in this branch.', 'bad');
    pillCount.textContent = '0 files';
    return;
  }

  // Parse names
  for (const f of treeFiles) {
    const name = f.path.split('/').pop();
    const m = name.match(NAME_RE);
    if (!m) continue;
    const family = m[1].replace(/_/g,''); // normalize (Flat_Head => FlatHead if ever appears)
    const dia = m[2].toUpperCase();       // M3, M10
    const len = parseInt(m[3], 10);       // 6, 30
    const key = `${family}|${dia}|${len}`;

    if (!indexMap.has(family)) indexMap.set(family, new Map());
    const dmap = indexMap.get(family);
    if (!dmap.has(dia)) dmap.set(dia, new Set());
    dmap.get(dia).add(len);
    pathMap.set(key, f.path);
  }

  // Build selects
  const families = Array.from(indexMap.keys()).sort((a,b)=>a.localeCompare(b));
  populateSelect(familySel, families);
  pillCount.textContent = `${pathMap.size} files`;
  setStatus(`Indexed ${pathMap.size} STL files from /Bolts/**/STL.`, 'ok');
}

function onFamilyChange() {
  const fam = familySel.value;
  pillFamily.textContent = fam || '—';
  if (!fam || !indexMap.has(fam)) { populateSelect(diamSel, []); populateSelect(lenSel, []); return; }
  const dmap = indexMap.get(fam);
  const dias = Array.from(dmap.keys()).sort((a,b)=>{
    // Sort by number after M
    const na = parseInt(a.slice(1),10); const nb = parseInt(b.slice(1),10);
    return na-nb;
  });
  populateSelect(diamSel, dias);
  populateSelect(lenSel, []);
}

function onDiaChange() {
  const fam = familySel.value;
  const dia = diamSel.value;
  pillDia.textContent = dia || '—';
  if (!fam || !dia) { populateSelect(lenSel, []); return; }
  const dmap = indexMap.get(fam);
  const lens = Array.from(dmap.get(dia) || []).sort(byNum);
  populateSelect(lenSel, lens.map(String));
}

function onLenChange() {
  const fam = familySel.value;
  const dia = diamSel.value;
  const len = parseInt(lenSel.value,10);
  pillLen.textContent = isFinite(len) ? (len+' mm') : '—';
  if (!fam || !dia || !isFinite(len)) return;
  const key = `${fam}|${dia}|${len}`;
  const path = pathMap.get(key);
  if (!path) return;
  const owner = $('#repoOwner').value.trim();
  const repo = $('#repoName').value.trim();
  const url = `https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${path}`;
  rawLink.href = url;
  loadSTL(url);
}

$('#btnReload').addEventListener('click', async ()=>{
  try {
    const owner = $('#repoOwner').value.trim();
    const repo  = $('#repoName').value.trim();
    await loadIndex(owner, repo);
  } catch (err) {
    console.error(err);
    setStatus('Error loading index: ' + (err && err.message ? err.message : String(err)), 'bad');
  }
});
familySel.addEventListener('change', onFamilyChange);
diamSel.addEventListener('change', onDiaChange);
lenSel .addEventListener('change', onLenChange);

// Kick off once
document.addEventListener('DOMContentLoaded', ()=> $('#btnReload').click());

// === Three.js viewer ===
import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
import { STLLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/STLLoader.js";

let renderer, scene, camera, controls, mesh;
const container = document.getElementById('three');

function initThree() {
  const w = container.clientWidth || container.parentElement.clientWidth;
  const h = container.clientHeight || 480;
  renderer = new THREE.WebGLRenderer({ antialias:true });
  renderer.setSize(w, h);
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.setClearColor(0x0b0d12);
  container.innerHTML = '';
  container.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
  camera.position.set(80, 60, 80);

  controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // Lights
  const amb = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(amb);
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(80, 100, 60);
  scene.add(dir);

  const grid = new THREE.GridHelper(400, 40, 0x2a3140, 0x2a3140);
  grid.position.y = -0.01;
  scene.add(grid);

  animate();
}
function animate() {
  requestAnimationFrame(animate);
  controls && controls.update();
  renderer && renderer.render(scene, camera);
}

function fitCameraToObject(object, offset = 1.35) {
  const box = new THREE.Box3().setFromObject(object);
  const size = box.getSize(new THREE.Vector3());
  const center = box.getCenter(new THREE.Vector3());

  const maxDim = Math.max(size.x, size.y, size.z);
  const fov = camera.fov * (Math.PI/180);
  let cameraZ = Math.abs(maxDim/2 / Math.tan(fov/2)) * offset;

  camera.position.set(center.x + cameraZ, center.y + cameraZ*0.6, center.z + cameraZ);
  camera.near = cameraZ/100;
  camera.far  = cameraZ*100;
  camera.updateProjectionMatrix();
  controls.target.copy(center);
  controls.update();
}

const loader = new STLLoader();
async function loadSTL(url) {
  setStatus('Loading model…');
  loader.load(
    url,
    (geom)=>{
      // dispose old
      if (mesh) { mesh.geometry.dispose(); scene.remove(mesh); mesh = null; }
      const mat = new THREE.MeshStandardMaterial({ metalness: 0.6, roughness: 0.35 });
      mesh = new THREE.Mesh(geom, mat);
      geom.computeBoundingBox();
      // Center
      const center = geom.boundingBox.getCenter(new THREE.Vector3()).multiplyScalar(-1);
      geom.translate(center.x, center.y, center.z);
      scene.add(mesh);
      fitCameraToObject(mesh);
      setStatus('Model loaded.', 'ok');
    },
    (xhr)=>{
      // progress
      if (xhr.total) {
        const pct = Math.round((xhr.loaded/xhr.total)*100);
        setStatus(`Loading model… ${pct}%`);
      }
    },
    (err)=>{
      console.error(err);
      setStatus('Failed to load model: ' + (err && err.message ? err.message : String(err)), 'bad');
    }
  );
}

// Resize handling
new ResizeObserver(()=>{
  if (!renderer) return;
  const w = container.clientWidth || container.parentElement.clientWidth;
  const h = container.clientHeight || 480;
  renderer.setSize(w, h);
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
}).observe(container);

initThree();
</script>
</body>
</html>
